<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë‘ë ˆìƒí˜‘ ì‚¬ì—…ë³´ê³  ì±„íŒ…ë°©</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒ¿</text></svg>">
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--green:#2D5016;--beige:#F5F0E8;--brown:#8B7355;--light-green:#E8F5E1;--my-bubble:#D4EDC9;--bot-bubble:#F0F8E8;--other-bubble:#fff}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans KR',sans-serif;background:var(--beige);height:100vh;height:100dvh;display:flex;flex-direction:column;overflow:hidden}

/* Nickname modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal-box{background:#fff;border-radius:20px;padding:28px 24px;width:min(340px,90vw);box-shadow:0 8px 32px rgba(0,0,0,.2);text-align:center}
.modal-box h2{color:var(--green);font-size:1.2em;margin-bottom:4px}
.modal-box p{color:#888;font-size:.85em;margin-bottom:18px}
.modal-box input,.modal-box select{width:100%;padding:11px 14px;border:1.5px solid #ddd;border-radius:12px;font-size:.95em;font-family:inherit;outline:none;margin-bottom:10px;-webkit-appearance:none}
.modal-box input:focus,.modal-box select:focus{border-color:var(--green)}
.modal-box button{width:100%;padding:12px;background:var(--green);color:#fff;border:none;border-radius:12px;font-size:1em;font-weight:700;cursor:pointer;margin-top:4px}
.modal-box button:disabled{opacity:.4;cursor:default}

/* Chat */
#chatScreen{display:flex;flex-direction:column;height:100%}
.chat-header{background:var(--green);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.chat-header .title{font-size:1.05em;font-weight:700}
.chat-header .subtitle{font-size:.75em;opacity:.85;margin-top:2px}
.header-right{display:flex;align-items:center;gap:8px}
.online-count{background:rgba(255,255,255,.2);padding:3px 10px;border-radius:10px;font-size:.78em;font-weight:600}
.settings-btn{background:none;border:none;color:#fff;font-size:1.1em;cursor:pointer;padding:4px}

.messages{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:8px;-webkit-overflow-scrolling:touch;scroll-behavior:smooth}
.msg-row{display:flex;align-items:flex-end;gap:6px;max-width:85%}
.msg-row.mine{align-self:flex-end;flex-direction:row-reverse}
.msg-row.other{align-self:flex-start}
.msg-row.bot{align-self:flex-start}
.avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.85em;flex-shrink:0;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.msg-row.mine .avatar{display:none}
.bubble{padding:10px 14px;border-radius:16px;font-size:.92em;line-height:1.5;word-break:break-word;position:relative;box-shadow:0 1px 2px rgba(0,0,0,.06)}
.msg-row.mine .bubble{background:var(--my-bubble);border-bottom-right-radius:4px;color:#1a3a0a}
.msg-row.other .bubble{background:var(--other-bubble);border-bottom-left-radius:4px;color:#333}
.msg-row.bot .bubble{background:var(--bot-bubble);border-bottom-left-radius:4px;color:#2D5016;border:1px solid #c5e1b5}
.sender-name{font-size:.75em;font-weight:700;margin-bottom:3px;display:flex;align-items:center;gap:5px}
.team-badge{display:inline-block;padding:1px 7px;border-radius:8px;font-size:.85em;color:#fff;font-weight:600;line-height:1.5}
.msg-time{font-size:.65em;color:#999;margin-top:3px;text-align:right}

.file-card{background:rgba(45,80,22,.08);border:1px solid rgba(45,80,22,.2);border-radius:10px;padding:10px 12px;margin-top:6px;display:flex;align-items:center;gap:8px}
.file-card .file-icon{font-size:1.5em}
.file-card .file-info{flex:1;min-width:0}
.file-card .file-name{font-size:.82em;font-weight:600;color:var(--green);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.report-btn{display:inline-block;background:var(--green);color:#fff;border:none;padding:10px 20px;border-radius:12px;font-size:.88em;cursor:pointer;margin-top:8px;text-decoration:none;font-weight:600}

.input-area{background:#fff;padding:8px 12px;display:flex;align-items:flex-end;gap:8px;flex-shrink:0;border-top:1px solid #e0d8cc;padding-bottom:max(8px,env(safe-area-inset-bottom))}
.input-area textarea{flex:1;border:1px solid #ddd;border-radius:20px;padding:10px 14px;font-size:.92em;resize:none;max-height:100px;min-height:40px;line-height:1.4;font-family:inherit;outline:none}
.input-area textarea:focus{border-color:var(--green)}
.input-area button{width:40px;height:40px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.2em;flex-shrink:0;transition:background .2s}
.attach-btn{background:var(--beige);color:var(--brown)}
.send-btn{background:var(--green);color:#fff}
.send-btn:active,.attach-btn:active{opacity:.7}
#fileInput{display:none}

.system-msg{text-align:center;font-size:.78em;color:#999;padding:6px 0}
.typing{align-self:flex-start;display:flex;align-items:center;gap:6px;padding:4px 0}
.typing .dots{display:flex;gap:3px}
.typing .dots span{width:6px;height:6px;border-radius:50%;background:#999;animation:blink 1.4s infinite both}
.typing .dots span:nth-child(2){animation-delay:.2s}
.typing .dots span:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}

.connection-badge{position:fixed;top:60px;right:10px;padding:3px 10px;border-radius:10px;font-size:.7em;font-weight:700;z-index:100;opacity:.85}
.connection-badge.ok{background:#4caf50;color:#fff}
.connection-badge.err{background:#f44336;color:#fff}

@media(min-width:600px){.messages{max-width:700px;margin:0 auto;width:100%}.input-area{max-width:700px;margin:0 auto;width:100%}}
</style>
</head>
<body>

<div id="chatScreen">
  <div class="chat-header">
    <div>
      <div class="title">ğŸŒ¿ ë‘ë ˆìƒí˜‘ ì‚¬ì—…ë³´ê³  ì±„íŒ…ë°©</div>
      <div class="subtitle" id="onlineStatus">ì ‘ì† ì¤‘</div>
    </div>
    <div class="header-right">
      <span class="online-count" id="onlineCount">0ëª… ì ‘ì†</span>
      <button class="settings-btn" onclick="showNicknameModal()" title="ë‹‰ë„¤ì„/íŒ€ ë³€ê²½">âš™ï¸</button>
    </div>
  </div>
  <div class="messages" id="messages"></div>
  <div class="input-area">
    <button class="attach-btn" onclick="document.getElementById('fileInput').click()">ğŸ“</button>
    <input type="file" id="fileInput" accept=".xlsx,.xls,.doc,.docx,.pdf,.hwp,.ppt,.pptx,.txt,.csv,.jpg,.jpeg,.png,.gif,.zip" onchange="handleFile(event)">
    <textarea id="msgInput" rows="1" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
    <button class="send-btn" onclick="sendMessage()">â¤</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_URL = 'https://basically-yearly-foo-statewide.trycloudflare.com';

const TEAM_COLORS = {
  'ì¶•ìˆ˜ì‚°íŒ€': '#1B5E20',
  'ë†ì‚°íŒ€': '#E65100',
  'ê°€ê³µíŒ€': '#1565C0',
  'ë§¤ì¥ì‚¬ì—…íŒ€': '#6A1B9A',
  'ì˜¨ë¼ì¸íŒ€': '#00838F',
  'ì‚¬ì—…ìƒë¬´': '#C62828'
};
const DEFAULT_COLOR = '#757575';

const TEAMS_LIST = ['ì¶•ìˆ˜ì‚°íŒ€','ë†ì‚°íŒ€','ê°€ê³µíŒ€','ë§¤ì¥ì‚¬ì—…íŒ€','ì˜¨ë¼ì¸íŒ€','ì‚¬ì—…ìƒë¬´'];

let currentUser = null; // { name, team }
let lastTimestamp = 0;
let pollTimer = null;
let renderedIds = new Set();
let onlineUsers = new Map(); // name -> { team, lastSeen }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Nickname Modal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showNicknameModal(isFirst) {
  if (document.querySelector('.modal-overlay')) return;
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  const name = currentUser?.name || '';
  const team = currentUser?.team || '';
  overlay.innerHTML = `<div class="modal-box">
    <h2>ğŸŒ¿ ${isFirst ? 'ì±„íŒ…ë°© ì…ì¥' : 'ë‹‰ë„¤ì„/íŒ€ ë³€ê²½'}</h2>
    <p>${isFirst ? 'ì´ë¦„ì„ ì…ë ¥í•˜ë©´ ë°”ë¡œ ì‹œì‘í•©ë‹ˆë‹¤' : 'ì •ë³´ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”'}</p>
    <input id="modalName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" value="${esc(name)}" maxlength="20" autocomplete="off">
    <select id="modalTeam">
      <option value="">íŒ€ ì„ íƒ ì•ˆ í•¨</option>
      ${TEAMS_LIST.map(t => `<option value="${t}" ${t===team?'selected':''}>${t}</option>`).join('')}
    </select>
    <button id="modalBtn" ${name?'':'disabled'}>ì…ì¥</button>
  </div>`;
  document.body.appendChild(overlay);

  const inp = document.getElementById('modalName');
  const btn = document.getElementById('modalBtn');
  inp.focus();
  inp.addEventListener('input', () => { btn.disabled = !inp.value.trim(); });
  inp.addEventListener('keydown', e => { if (e.key === 'Enter' && inp.value.trim()) btn.click(); });

  if (!isFirst) {
    overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
  }

  btn.onclick = () => {
    const n = inp.value.trim();
    if (!n) return;
    const t = document.getElementById('modalTeam').value;
    const oldName = currentUser?.name;
    currentUser = { name: n, team: t };
    localStorage.setItem('dure-chat-user', JSON.stringify(currentUser));
    overlay.remove();
    updateHeaderInfo();
    if (isFirst || !oldName) {
      announceJoin();
      loadMessages();
      startPolling();
    }
  };
}

function updateHeaderInfo() {
  const sub = document.getElementById('onlineStatus');
  if (currentUser) {
    sub.textContent = currentUser.team ? `${currentUser.name} (${currentUser.team})` : currentUser.name;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Online tracking (simple via polling)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateOnlineCount(count) {
  document.getElementById('onlineCount').textContent = `${count || 1}ëª… ì ‘ì†`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Connection
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkConnection() {
  try {
    const r = await fetch(API_URL + '/api/health', { signal: AbortSignal.timeout(5000) });
    if (r.ok) { showBadge('ok','ğŸŸ¢ ì—°ê²°ë¨'); return true; }
  } catch {}
  showBadge('err','ğŸ”´ ì„œë²„ ì˜¤í”„ë¼ì¸');
  return false;
}
function showBadge(cls, text) {
  let b = document.querySelector('.connection-badge');
  if (!b) { b = document.createElement('div'); b.className = 'connection-badge'; document.body.appendChild(b); }
  b.className = 'connection-badge ' + cls;
  b.textContent = text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Polling
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startPolling() { stopPolling(); pollTimer = setInterval(pollMessages, 3000); }
function stopPolling() { if (pollTimer) clearInterval(pollTimer); pollTimer = null; }

async function pollMessages() {
  try {
    const r = await fetch(`${API_URL}/api/messages?since=${lastTimestamp}&user=${encodeURIComponent(currentUser?.name||'')}`);
    const data = await r.json();
    if (data.onlineCount) updateOnlineCount(data.onlineCount);
    if (data.messages?.length) {
      data.messages.forEach(m => {
        if (!renderedIds.has(m.id)) {
          renderMessage(m);
          renderedIds.add(m.id);
          if (m.timestamp > lastTimestamp) lastTimestamp = m.timestamp;
        }
      });
    }
  } catch {}
}

async function loadMessages() {
  try {
    const r = await fetch(`${API_URL}/api/messages?since=0`);
    const data = await r.json();
    if (data.onlineCount) updateOnlineCount(data.onlineCount);
    if (data.messages) {
      data.messages.forEach(m => {
        if (!renderedIds.has(m.id)) {
          renderMessage(m);
          renderedIds.add(m.id);
          if (m.timestamp > lastTimestamp) lastTimestamp = m.timestamp;
        }
      });
    }
  } catch {
    addSystemMsg('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Announce join
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function announceJoin() {
  try {
    await fetch(API_URL + '/api/join', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: currentUser.name, team: currentUser.team })
    });
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Render
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function teamColor(team) { return TEAM_COLORS[team] || DEFAULT_COLOR; }

function renderMessage(msg) {
  const container = document.getElementById('messages');

  if (msg.type === 'system') {
    const div = document.createElement('div');
    div.className = 'system-msg';
    div.textContent = msg.text;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    return;
  }

  const isMine = currentUser && msg.sender === currentUser.name && msg.team === currentUser.team && msg.type === 'user';
  const isBot = msg.type === 'bot';
  const row = document.createElement('div');
  row.className = `msg-row ${isMine ? 'mine' : isBot ? 'bot' : 'other'}`;

  const avatarEmoji = isBot ? 'ğŸ§ ' : 'ğŸ‘¤';

  let fileHtml = '';
  if (msg.fileName) {
    const icon = getFileIcon(msg.fileName);
    fileHtml = `<div class="file-card"><div class="file-icon">${icon}</div><div class="file-info"><div class="file-name">${esc(msg.fileName)}</div></div></div>`;
  }

  let reportHtml = '';
  if (msg.hasReport) {
    reportHtml = `<div style="margin-top:8px">
      <a class="report-btn" href="${API_URL}/api/report?format=html" target="_blank">ğŸ“‹ HTML ë³´ê³ ì„œ</a>
      <a class="report-btn" style="background:var(--brown);margin-left:6px" href="${API_URL}/api/report?format=xlsx" target="_blank">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</a></div>`;
  }

  const senderTeam = msg.team || '';
  const badgeHtml = senderTeam ? `<span class="team-badge" style="background:${teamColor(senderTeam)}">${esc(senderTeam)}</span>` : '';
  const senderLabel = isBot ? 'í´ë¡œì´' : esc(msg.sender || '');

  const time = new Date(msg.timestamp).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
  row.innerHTML = `
    <div class="avatar">${avatarEmoji}</div>
    <div class="bubble">
      ${!isMine ? `<div class="sender-name">${senderLabel} ${badgeHtml}</div>` : ''}
      <div>${formatText(msg.text||'')}</div>
      ${fileHtml}${reportHtml}
      <div class="msg-time">${time}</div>
    </div>`;
  container.appendChild(row);
  container.scrollTop = container.scrollHeight;
}

function addSystemMsg(text) {
  const container = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'system-msg';
  div.textContent = text;
  container.appendChild(div);
}

function showTyping() {
  const container = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'typing';
  div.id = 'typingIndicator';
  div.innerHTML = `<div class="avatar">ğŸ§ </div><div class="dots"><span></span><span></span><span></span></div>`;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}
function hideTyping() { document.getElementById('typingIndicator')?.remove(); }

function formatText(t) { return esc(t).replace(/\n/g,'<br>'); }
function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function getFileIcon(name) {
  const ext = (name.split('.').pop()||'').toLowerCase();
  const icons = {xlsx:'ğŸ“Š',xls:'ğŸ“Š',csv:'ğŸ“Š',doc:'ğŸ“',docx:'ğŸ“',hwp:'ğŸ“',pdf:'ğŸ“•',ppt:'ğŸ“™',pptx:'ğŸ“™',txt:'ğŸ“„',jpg:'ğŸ–¼ï¸',jpeg:'ğŸ–¼ï¸',png:'ğŸ–¼ï¸',gif:'ğŸ–¼ï¸',zip:'ğŸ“¦'};
  return icons[ext]||'ğŸ“„';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Send Message â€” ALL messages go to server,
// server decides whether bot replies
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendMessage() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text || !currentUser) return;
  input.value = '';
  autoResize(input);

  // Determine if this is a command or bot mention (show typing for those)
  const isBotCall = /^[\/]/.test(text) || /^@(í´ë¡œì´|ë´‡)/.test(text);
  if (isBotCall) showTyping();

  try {
    const r = await fetch(API_URL + '/api/message', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        text,
        sender: currentUser.name,
        team: currentUser.team
      })
    });
    const data = await r.json();
    hideTyping();

    // Render user message from response
    if (data.message && !renderedIds.has(data.message.id)) {
      renderMessage(data.message);
      renderedIds.add(data.message.id);
      if (data.message.timestamp > lastTimestamp) lastTimestamp = data.message.timestamp;
    }

    // Render bot reply ONLY if server returned one
    if (data.botReply && !renderedIds.has(data.botReply.id)) {
      renderMessage(data.botReply);
      renderedIds.add(data.botReply.id);
      if (data.botReply.timestamp > lastTimestamp) lastTimestamp = data.botReply.timestamp;
    }
  } catch (err) {
    hideTyping();
    addSystemMsg('âš ï¸ ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// File Upload
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function handleFile(e) {
  const file = e.target.files[0];
  if (!file || !currentUser) return;
  e.target.value = '';
  if (file.size > 10 * 1024 * 1024) { addSystemMsg('âš ï¸ íŒŒì¼ í¬ê¸°ê°€ 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.'); return; }

  showTyping();
  try {
    const fd = new FormData();
    fd.append('file', file);
    fd.append('sender', currentUser.name);
    fd.append('team', currentUser.team);

    const r = await fetch(API_URL + '/api/upload', { method: 'POST', body: fd });
    const data = await r.json();
    hideTyping();
    if (data.message && !renderedIds.has(data.message.id)) {
      renderMessage(data.message);
      renderedIds.add(data.message.id);
      if (data.message.timestamp > lastTimestamp) lastTimestamp = data.message.timestamp;
    }
    if (data.botReply && !renderedIds.has(data.botReply.id)) {
      renderMessage(data.botReply);
      renderedIds.add(data.botReply.id);
      if (data.botReply.timestamp > lastTimestamp) lastTimestamp = data.botReply.timestamp;
    }
  } catch {
    hideTyping();
    addSystemMsg('âš ï¸ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨.');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
checkConnection();
const saved = localStorage.getItem('dure-chat-user');
if (saved) {
  try {
    currentUser = JSON.parse(saved);
    updateHeaderInfo();
    announceJoin();
    loadMessages();
    startPolling();
  } catch { showNicknameModal(true); }
} else {
  showNicknameModal(true);
}
</script>
</body>
</html>
