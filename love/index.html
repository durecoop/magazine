<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ğŸ’• ìš°ë¦¬ ë‘˜ì˜ ì±„íŒ…ë°©</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’•</text></svg>">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--pink:#E91E63;--bg:#FFF0F5;--accent:#FF6F91;--my-bubble:#FCE4EC;--other-bubble:#fff;--bot-bubble:#FFF3E0;--rose-gold:#B76E79;--light-pink:#F8BBD0;--deep-pink:#C2185B}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans KR',sans-serif;background:var(--bg);height:100vh;height:100dvh;display:flex;flex-direction:column;overflow:hidden}

/* Login */
#loginScreen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:20px;background:linear-gradient(135deg,#E91E63 0%,#FF6F91 50%,#F8BBD0 100%)}
#loginScreen h1{color:#fff;font-size:1.8em;margin-bottom:4px;text-shadow:0 2px 8px rgba(0,0,0,.15)}
#loginScreen .subtitle{color:rgba(255,255,255,.9);font-size:.9em;margin-bottom:30px}
.login-box{background:rgba(255,255,255,.95);border-radius:24px;padding:30px 24px;width:100%;max-width:360px;text-align:center;box-shadow:0 8px 32px rgba(233,30,99,.3)}
.login-box .heart-big{font-size:3em;margin-bottom:12px;animation:heartbeat 1.5s ease-in-out infinite}
@keyframes heartbeat{0%,100%{transform:scale(1)}14%{transform:scale(1.15)}28%{transform:scale(1)}42%{transform:scale(1.1)}70%{transform:scale(1)}}
.login-box label{display:block;text-align:left;font-size:.85em;color:var(--rose-gold);font-weight:600;margin-bottom:6px;margin-top:16px}
.login-box input{width:100%;border:2px solid var(--light-pink);border-radius:14px;padding:12px 16px;font-size:1em;outline:none;transition:border .2s;font-family:inherit}
.login-box input:focus{border-color:var(--pink)}
.login-box button{width:100%;margin-top:20px;background:linear-gradient(135deg,var(--pink),var(--accent));color:#fff;border:none;padding:14px;border-radius:14px;font-size:1em;font-weight:700;cursor:pointer;transition:transform .2s,box-shadow .2s;box-shadow:0 4px 16px rgba(233,30,99,.3)}
.login-box button:active{transform:scale(.97)}

/* Chat Screen */
#chatScreen{display:none;flex-direction:column;height:100%}
.chat-header{background:linear-gradient(135deg,var(--pink),var(--accent));color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;box-shadow:0 2px 12px rgba(233,30,99,.25)}
.chat-header .title{font-size:1.05em;font-weight:700}
.chat-header .subtitle{font-size:.72em;opacity:.9;margin-top:2px}
.header-left{display:flex;align-items:center;gap:10px}
.header-right{display:flex;align-items:center;gap:8px}
.header-btn{background:rgba(255,255,255,.2);border:none;color:#fff;font-size:1.1em;cursor:pointer;padding:6px 8px;border-radius:10px;transition:background .2s}
.header-btn:active{background:rgba(255,255,255,.35)}

/* D-Day Bar */
.dday-bar{background:rgba(233,30,99,.06);padding:8px 16px;display:flex;align-items:center;justify-content:center;gap:8px;flex-shrink:0;border-bottom:1px solid rgba(233,30,99,.1);font-size:.82em;color:var(--deep-pink)}
.dday-bar .heart-icon{animation:heartbeat 2s ease-in-out infinite}
.dday-bar .dday-text{font-weight:700}
.dday-bar .dday-set{color:var(--rose-gold);cursor:pointer;font-size:.85em;opacity:.7;text-decoration:underline}

/* Messages */
.messages{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:8px;-webkit-overflow-scrolling:touch;scroll-behavior:smooth}
.msg-row{display:flex;align-items:flex-end;gap:6px;max-width:82%}
.msg-row.mine{align-self:flex-end;flex-direction:row-reverse}
.msg-row.other{align-self:flex-start}
.msg-row.bot{align-self:flex-start}
.avatar{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9em;flex-shrink:0;background:#fff;box-shadow:0 2px 6px rgba(233,30,99,.15)}
.msg-row.mine .avatar{display:none}
.bubble{padding:10px 14px;border-radius:18px;font-size:.92em;line-height:1.55;word-break:break-word;position:relative;box-shadow:0 1px 4px rgba(0,0,0,.06);transition:transform .15s}
.msg-row.mine .bubble{background:var(--my-bubble);border-bottom-right-radius:4px;color:#880E4F}
.msg-row.other .bubble{background:var(--other-bubble);border-bottom-left-radius:4px;color:#333;border:1px solid rgba(233,30,99,.1)}
.msg-row.bot .bubble{background:var(--bot-bubble);border-bottom-left-radius:4px;color:#E65100;border:1px solid #FFE0B2}
.sender-name{font-size:.75em;font-weight:700;color:var(--rose-gold);margin-bottom:3px}
.msg-time{font-size:.65em;color:#caa;margin-top:3px;text-align:right}
.heart-reaction{position:absolute;bottom:-8px;right:8px;background:#fff;border-radius:12px;padding:2px 6px;font-size:.7em;box-shadow:0 1px 4px rgba(0,0,0,.1);display:none;cursor:pointer;user-select:none}
.heart-reaction.show{display:block;animation:popIn .3s ease}
@keyframes popIn{0%{transform:scale(0)}50%{transform:scale(1.3)}100%{transform:scale(1)}}

/* File */
.file-card{background:rgba(233,30,99,.06);border:1px solid rgba(233,30,99,.15);border-radius:12px;padding:10px 12px;margin-top:6px;display:flex;align-items:center;gap:8px}
.file-card .file-icon{font-size:1.5em}
.file-card .file-info{flex:1;min-width:0}
.file-card .file-name{font-size:.82em;font-weight:600;color:var(--deep-pink);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.file-card .file-size{font-size:.7em;color:#bbb}

/* Image preview */
.img-preview{max-width:240px;max-height:240px;border-radius:12px;margin-top:6px;cursor:pointer;object-fit:cover}

/* Input */
.input-area{background:#fff;padding:8px 12px;display:flex;align-items:flex-end;gap:8px;flex-shrink:0;border-top:1px solid rgba(233,30,99,.1);padding-bottom:max(8px,env(safe-area-inset-bottom))}
.input-area textarea{flex:1;border:2px solid rgba(233,30,99,.15);border-radius:20px;padding:10px 14px;font-size:.92em;resize:none;max-height:100px;min-height:40px;line-height:1.4;font-family:inherit;outline:none;transition:border .2s}
.input-area textarea:focus{border-color:var(--pink)}
.input-area button{width:40px;height:40px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.2em;flex-shrink:0;transition:all .2s}
.attach-btn{background:var(--bg);color:var(--rose-gold)}
.send-btn{background:linear-gradient(135deg,var(--pink),var(--accent));color:#fff;box-shadow:0 2px 8px rgba(233,30,99,.3)}
.send-btn:active,.attach-btn:active{transform:scale(.9)}
#fileInput{display:none}

.system-msg{text-align:center;font-size:.78em;color:#caa;padding:4px 0}
.typing{align-self:flex-start;display:flex;align-items:center;gap:6px;padding:4px 0}
.typing .dots{display:flex;gap:3px}
.typing .dots span{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:blink 1.4s infinite both}
.typing .dots span:nth-child(2){animation-delay:.2s}
.typing .dots span:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}
.connection-badge{position:fixed;top:60px;right:10px;padding:3px 10px;border-radius:10px;font-size:.7em;font-weight:700;z-index:100;opacity:.85}
.connection-badge.ok{background:var(--pink);color:#fff}
.connection-badge.err{background:#f44336;color:#fff}

/* Date picker modal */
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);z-index:200;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal-box{background:#fff;border-radius:20px;padding:24px;width:90%;max-width:320px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.2)}
.modal-box h3{color:var(--pink);margin-bottom:16px}
.modal-box input[type=date]{width:100%;padding:12px;border:2px solid var(--light-pink);border-radius:12px;font-size:1em;outline:none}
.modal-box input[type=date]:focus{border-color:var(--pink)}
.modal-box .modal-btns{display:flex;gap:10px;margin-top:16px}
.modal-box .modal-btns button{flex:1;padding:10px;border:none;border-radius:12px;font-size:.9em;font-weight:600;cursor:pointer}
.modal-box .btn-cancel{background:#f5f5f5;color:#999}
.modal-box .btn-save{background:var(--pink);color:#fff}

/* Floating hearts animation */
.float-heart{position:fixed;bottom:-20px;font-size:1.2em;opacity:.6;pointer-events:none;z-index:0;animation:floatUp 6s linear forwards}
@keyframes floatUp{0%{transform:translateY(0) rotate(0deg);opacity:.6}100%{transform:translateY(-110vh) rotate(360deg);opacity:0}}

@media(min-width:600px){.messages{max-width:600px;margin:0 auto;width:100%}.input-area{max-width:600px;margin:0 auto;width:100%}}
</style>
</head>
<body>

<!-- Floating hearts background -->
<div id="floatingHearts"></div>

<div id="loginScreen">
  <h1>ğŸ’• ìš°ë¦¬ ë‘˜ì˜ ì±„íŒ…ë°©</h1>
  <p class="subtitle">ë‘˜ë§Œì˜ ë¹„ë°€ ê³µê°„</p>
  <div class="login-box">
    <div class="heart-big">ğŸ’—</div>
    <p style="color:var(--rose-gold);font-size:.9em">ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê³  ì…ì¥í•˜ì„¸ìš”</p>
    <label for="nicknameInput">ë‹‰ë„¤ì„</label>
    <input type="text" id="nicknameInput" placeholder="ì˜ˆ: ìê¸°ì•¼, ì—¬ë³´, ê¿€ë–¡ì´..." maxlength="12" autocomplete="off">
    <button onclick="doLogin()">ì…ì¥í•˜ê¸° ğŸ’•</button>
  </div>
</div>

<div id="chatScreen">
  <div class="chat-header">
    <div class="header-left">
      <div>
        <div class="title">ğŸ’• ìš°ë¦¬ ë‘˜ì˜ ì±„íŒ…ë°©</div>
        <div class="subtitle" id="onlineStatus">ì ‘ì† ì¤‘</div>
      </div>
    </div>
    <div class="header-right">
      <button class="header-btn" onclick="openDateModal()" title="ê¸°ë…ì¼ ì„¤ì •">ğŸ“…</button>
      <button class="header-btn" onclick="logout()" title="ë‚˜ê°€ê¸°">ğŸšª</button>
    </div>
  </div>
  <div class="dday-bar" id="ddayBar">
    <span class="heart-icon">ğŸ’—</span>
    <span class="dday-text" id="ddayText">ê¸°ë…ì¼ì„ ì„¤ì •í•´ì£¼ì„¸ìš”</span>
    <span class="dday-set" onclick="openDateModal()">ì„¤ì •</span>
  </div>
  <div class="messages" id="messages"></div>
  <div class="input-area">
    <button class="attach-btn" onclick="document.getElementById('fileInput').click()">ğŸ“</button>
    <input type="file" id="fileInput" accept=".xlsx,.xls,.doc,.docx,.pdf,.hwp,.ppt,.pptx,.txt,.csv,.jpg,.jpeg,.png,.gif,.webp,.mp4,.zip" onchange="handleFile(event)">
    <textarea id="msgInput" rows="1" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”... ğŸ’•" onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
    <button class="send-btn" onclick="sendMessage()">ğŸ’Œ</button>
  </div>
</div>

<!-- Date picker modal -->
<div class="modal-overlay" id="dateModal">
  <div class="modal-box">
    <h3>ğŸ’• ì‚¬ê·„ ë‚ ì§œ ì„¤ì •</h3>
    <p style="font-size:.85em;color:#999;margin-bottom:12px">ìš°ë¦¬ê°€ ì‹œì‘ëœ ë‚ ì„ ì•Œë ¤ì£¼ì„¸ìš”</p>
    <input type="date" id="anniversaryInput">
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeDateModal()">ì·¨ì†Œ</button>
      <button class="btn-save" onclick="saveAnniversary()">ì €ì¥ ğŸ’—</button>
    </div>
  </div>
</div>

<script>
const API_URL = 'https://basically-yearly-foo-statewide.trycloudflare.com';
const ROOM_ID = 'love-chat';

let currentUser = null;
let lastTimestamp = 0;
let pollTimer = null;
let renderedIds = new Set();
const BOT_NAME = 'ì‹­í˜•í˜¸ ğŸ§ ';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Floating hearts background
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnHeart() {
  const hearts = ['ğŸ’•','ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’','â¤ï¸','ğŸ©·'];
  const el = document.createElement('div');
  el.className = 'float-heart';
  el.textContent = hearts[Math.floor(Math.random()*hearts.length)];
  el.style.left = Math.random()*100 + 'vw';
  el.style.fontSize = (0.8 + Math.random()*1.2) + 'em';
  el.style.animationDuration = (5 + Math.random()*5) + 's';
  document.getElementById('floatingHearts').appendChild(el);
  setTimeout(() => el.remove(), 10000);
}
setInterval(spawnHeart, 3000);
spawnHeart();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Connection
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkConnection() {
  try {
    const r = await fetch(API_URL + '/api/health', { signal: AbortSignal.timeout(5000) });
    if (r.ok) { showBadge('ok','ğŸ’— ì—°ê²°ë¨'); return true; }
  } catch {}
  showBadge('err','ğŸ’” ì„œë²„ ì˜¤í”„ë¼ì¸');
  return false;
}
function showBadge(cls, text) {
  let b = document.querySelector('.connection-badge');
  if (!b) { b = document.createElement('div'); b.className = 'connection-badge'; document.body.appendChild(b); }
  b.className = 'connection-badge ' + cls;
  b.textContent = text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// D-Day
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDateModal() {
  const saved = localStorage.getItem('love-anniversary');
  if (saved) document.getElementById('anniversaryInput').value = saved;
  document.getElementById('dateModal').classList.add('show');
}
function closeDateModal() { document.getElementById('dateModal').classList.remove('show'); }
function saveAnniversary() {
  const val = document.getElementById('anniversaryInput').value;
  if (!val) return;
  localStorage.setItem('love-anniversary', val);
  updateDday();
  closeDateModal();
}
function updateDday() {
  const saved = localStorage.getItem('love-anniversary');
  if (!saved) return;
  const start = new Date(saved);
  const now = new Date();
  const diff = Math.floor((now - start) / (1000*60*60*24));
  document.getElementById('ddayText').textContent = `í•¨ê»˜í•œ ë‚ : D+${diff}ì¼ ğŸ’•`;
  document.querySelector('.dday-set').textContent = saved;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Login
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doLogin() {
  const name = document.getElementById('nicknameInput').value.trim();
  if (!name) { document.getElementById('nicknameInput').focus(); return; }
  currentUser = { name, emoji: 'ğŸ’—' };
  localStorage.setItem('love-chat-user', JSON.stringify(currentUser));
  enterChat();
}
function enterChat() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('chatScreen').style.display = 'flex';
  document.getElementById('onlineStatus').textContent = `${currentUser.name} ì ‘ì† ì¤‘`;
  updateDday();
  checkConnection();
  loadMessages();
  startPolling();
}
function logout() {
  currentUser = null;
  localStorage.removeItem('love-chat-user');
  stopPolling();
  renderedIds.clear();
  lastTimestamp = 0;
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('chatScreen').style.display = 'none';
  document.getElementById('messages').innerHTML = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Polling
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startPolling() { stopPolling(); pollTimer = setInterval(pollMessages, 3000); }
function stopPolling() { if (pollTimer) clearInterval(pollTimer); pollTimer = null; }

async function pollMessages() {
  try {
    const r = await fetch(`${API_URL}/api/messages?since=${lastTimestamp}&room=${ROOM_ID}`);
    const data = await r.json();
    if (data.messages && data.messages.length) {
      data.messages.forEach(m => {
        if (!renderedIds.has(m.id)) {
          renderMessage(m);
          renderedIds.add(m.id);
          if (m.timestamp > lastTimestamp) lastTimestamp = m.timestamp;
        }
      });
    }
  } catch {}
}

async function loadMessages() {
  try {
    const r = await fetch(`${API_URL}/api/messages?since=0&room=${ROOM_ID}`);
    const data = await r.json();
    if (data.messages) {
      data.messages.forEach(m => {
        if (!renderedIds.has(m.id)) {
          renderMessage(m);
          renderedIds.add(m.id);
          if (m.timestamp > lastTimestamp) lastTimestamp = m.timestamp;
        }
      });
    }
  } catch {
    addSystemMsg('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Render
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMessage(msg) {
  const container = document.getElementById('messages');
  if (msg.type === 'system') {
    addSystemMsg(msg.text);
    return;
  }
  const isMine = currentUser && msg.sender === currentUser.name && msg.type === 'user';
  const isBot = msg.type === 'bot';
  const row = document.createElement('div');
  row.className = `msg-row ${isMine ? 'mine' : isBot ? 'bot' : 'other'}`;
  const avatarEmoji = isBot ? 'ğŸ§ ' : 'ğŸ’—';

  let fileHtml = '';
  if (msg.fileName) {
    const ext = (msg.fileName.split('.').pop()||'').toLowerCase();
    if (['jpg','jpeg','png','gif','webp'].includes(ext) && msg.fileUrl) {
      fileHtml = `<img class="img-preview" src="${esc(msg.fileUrl)}" alt="${esc(msg.fileName)}" onclick="window.open(this.src)">`;
    } else {
      const icon = getFileIcon(msg.fileName);
      fileHtml = `<div class="file-card"><div class="file-icon">${icon}</div><div class="file-info"><div class="file-name">${esc(msg.fileName)}</div></div></div>`;
    }
  }

  const time = new Date(msg.timestamp).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
  const msgId = msg.id || Date.now();
  row.innerHTML = `
    <div class="avatar">${avatarEmoji}</div>
    <div class="bubble" data-msgid="${msgId}">
      ${!isMine ? `<div class="sender-name">${esc(msg.sender)}</div>` : ''}
      <div>${formatText(msg.text||'')}</div>
      ${fileHtml}
      <div class="msg-time">${time}</div>
      <div class="heart-reaction" data-msgid="${msgId}">â¤ï¸ <span class="react-count">0</span></div>
    </div>`;
  
  // Double-tap for heart reaction
  const bubble = row.querySelector('.bubble');
  let lastTap = 0;
  bubble.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTap < 300) {
      toggleHeart(msgId);
      e.preventDefault();
    }
    lastTap = now;
  });
  bubble.addEventListener('dblclick', () => toggleHeart(msgId));

  container.appendChild(row);
  container.scrollTop = container.scrollHeight;
}

function toggleHeart(msgId) {
  const hearts = JSON.parse(localStorage.getItem('love-hearts')||'{}');
  hearts[msgId] = (hearts[msgId]||0) + 1;
  localStorage.setItem('love-hearts', JSON.stringify(hearts));
  const el = document.querySelector(`.heart-reaction[data-msgid="${msgId}"]`);
  if (el) {
    el.classList.add('show');
    el.querySelector('.react-count').textContent = hearts[msgId];
  }
  // Burst hearts effect
  burstHearts();
}

function burstHearts() {
  for (let i = 0; i < 5; i++) {
    setTimeout(spawnHeart, i * 100);
  }
}

function addSystemMsg(text) {
  const container = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'system-msg';
  div.textContent = text;
  container.appendChild(div);
}

function showTyping() {
  const container = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'typing'; div.id = 'typingIndicator';
  div.innerHTML = `<div class="avatar">ğŸ§ </div><div class="dots"><span></span><span></span><span></span></div>`;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}
function hideTyping() { const el = document.getElementById('typingIndicator'); if (el) el.remove(); }

function formatText(t) { return esc(t).replace(/\n/g,'<br>'); }
function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function getFileIcon(name) {
  const ext = (name.split('.').pop()||'').toLowerCase();
  const icons = {xlsx:'ğŸ“Š',xls:'ğŸ“Š',csv:'ğŸ“Š',doc:'ğŸ“',docx:'ğŸ“',hwp:'ğŸ“',pdf:'ğŸ“•',ppt:'ğŸ“™',pptx:'ğŸ“™',txt:'ğŸ“„',jpg:'ğŸ–¼ï¸',jpeg:'ğŸ–¼ï¸',png:'ğŸ–¼ï¸',gif:'ğŸ–¼ï¸',zip:'ğŸ“¦',mp4:'ğŸ¬'};
  return icons[ext]||'ğŸ“„';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Send
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendMessage() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text || !currentUser) return;
  input.value = '';
  autoResize(input);

  showTyping();
  try {
    const r = await fetch(API_URL + '/api/message', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        text,
        sender: currentUser.name,
        team: 'ì»¤í”Œ',
        teamId: 'love',
        room: ROOM_ID
      })
    });
    const data = await r.json();
    hideTyping();
    if (data.message && !renderedIds.has(data.message.id)) {
      renderMessage(data.message);
      renderedIds.add(data.message.id);
      if (data.message.timestamp > lastTimestamp) lastTimestamp = data.message.timestamp;
    }
  } catch {
    hideTyping();
    addSystemMsg('âš ï¸ ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// File Upload
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function handleFile(e) {
  const file = e.target.files[0];
  if (!file || !currentUser) return;
  e.target.value = '';
  if (file.size > 10*1024*1024) { addSystemMsg('âš ï¸ íŒŒì¼ í¬ê¸°ê°€ 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.'); return; }
  showTyping();
  try {
    const fd = new FormData();
    fd.append('file', file);
    fd.append('sender', currentUser.name);
    fd.append('team', 'ì»¤í”Œ');
    fd.append('teamId', 'love');
    fd.append('room', ROOM_ID);
    const r = await fetch(API_URL + '/api/upload', { method: 'POST', body: fd });
    const data = await r.json();
    hideTyping();
    if (data.message && !renderedIds.has(data.message.id)) {
      renderMessage(data.message);
      renderedIds.add(data.message.id);
      if (data.message.timestamp > lastTimestamp) lastTimestamp = data.message.timestamp;
    }
  } catch {
    hideTyping();
    addSystemMsg('âš ï¸ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨.');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const saved = localStorage.getItem('love-chat-user');
if (saved) { try { currentUser = JSON.parse(saved); enterChat(); } catch {} }

// Enter key on nickname input
document.getElementById('nicknameInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') doLogin();
});
</script>
</body>
</html>
