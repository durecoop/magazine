<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>ğŸ’• ì—°ì¸ë°©</title>
<style>
:root{--bg:#FFF5F8;--card:#FFFFFF;--primary:#E8778B;--primary-dark:#D4566E;--accent:#C9A0B0;--text:#4A3540;--text-light:#9B8A92;--bubble-me:#FFE0E8;--bubble-other:#FFF;--bubble-bot:#F8E8F0;--border:#F0D8E0;--header:linear-gradient(135deg,#E8778B,#D4A0C0);--heart:#FF4D6D}
*{margin:0;padding:0;box-sizing:border-box}
html{height:100%;height:100dvh}
body{font-family:-apple-system,'Noto Sans KR',sans-serif;background:var(--bg);height:100%;display:flex;flex-direction:column;color:var(--text);overflow:hidden}
.header{background:var(--header);color:#fff;padding:12px 16px;padding-top:max(12px,env(safe-area-inset-top));display:flex;align-items:center;justify-content:space-between;flex-shrink:0;z-index:10;position:relative}
.header h1{font-size:16px;font-weight:700}.header-sub{font-size:11px;opacity:.85;margin-top:1px}
.header-right{display:flex;gap:8px;align-items:center}
.btn-icon{background:none;border:none;color:#fff;font-size:18px;cursor:pointer;padding:4px}
.dday{background:rgba(255,255,255,.25);padding:3px 10px;border-radius:12px;font-size:12px;font-weight:600}
.messages{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:6px;-webkit-overflow-scrolling:touch}
.msg{max-width:80%;padding:8px 12px;border-radius:16px;font-size:14px;line-height:1.5;word-break:break-word;position:relative;transition:transform .1s}
.msg.me{align-self:flex-end;background:var(--bubble-me);border-bottom-right-radius:4px}
.msg.other{align-self:flex-start;background:var(--bubble-other);border-bottom-left-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
.msg.bot{align-self:flex-start;background:var(--bubble-bot);border-bottom-left-radius:4px;border-left:3px solid var(--primary)}
.msg .sender{font-size:11px;font-weight:700;color:var(--primary);margin-bottom:2px}
.msg .time{font-size:10px;color:var(--text-light);text-align:right;margin-top:2px}
.msg .heart-btn{position:absolute;right:-28px;top:50%;transform:translateY(-50%);font-size:16px;cursor:pointer;opacity:.3;transition:all .2s}
.msg .heart-btn:hover,.msg .heart-btn.active{opacity:1;transform:translateY(-50%) scale(1.3)}
.msg .file-link{display:inline-block;background:var(--primary);color:#fff;padding:3px 10px;border-radius:8px;font-size:12px;text-decoration:none;margin-top:4px}
.system-msg{text-align:center;font-size:12px;color:var(--accent);padding:4px 0}
.input-area{background:var(--card);border-top:1px solid var(--border);padding:8px 12px;padding-bottom:max(8px,env(safe-area-inset-bottom));display:flex;gap:8px;align-items:center;flex-shrink:0}
.input-area input[type=text]{flex:1;border:1px solid var(--border);border-radius:20px;padding:8px 14px;font-size:14px;outline:none;background:var(--bg)}
.input-area input[type=text]:focus{border-color:var(--primary)}
.send-btn{background:var(--primary);color:#fff;border:none;border-radius:50%;width:36px;height:36px;font-size:18px;cursor:pointer;flex-shrink:0}
.upload-btn{background:none;border:none;font-size:22px;cursor:pointer;color:var(--accent);flex-shrink:0}
/* Login */
.login-overlay{position:fixed;inset:0;background:var(--bg);z-index:100;display:flex;align-items:center;justify-content:center}
.login-box{background:var(--card);padding:32px 24px;border-radius:20px;width:min(320px,90vw);box-shadow:0 8px 30px rgba(232,119,139,.15);text-align:center}
.login-box h2{color:var(--primary);margin-bottom:4px;font-size:22px}.login-box p{color:var(--accent);font-size:13px;margin-bottom:20px}
.login-box input{width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;font-size:14px;margin-bottom:12px;background:#fff;text-align:center}
.login-box button{width:100%;padding:10px;background:var(--primary);color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer}
/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:200;display:none;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:#fff;border-radius:16px;padding:24px;width:min(320px,90vw)}
.modal h3{margin-bottom:16px;color:var(--primary)}.modal label{display:block;font-size:13px;color:var(--text-light);margin-bottom:4px}
.modal input{width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;margin-bottom:12px;font-size:14px}
.modal button{padding:8px 16px;border:none;border-radius:8px;cursor:pointer;font-size:14px}
.modal .btn-primary{background:var(--primary);color:#fff}.modal .btn-cancel{background:#eee;color:#333;margin-left:8px}
/* Floating hearts */
.floating-heart{position:fixed;pointer-events:none;font-size:20px;z-index:50;animation:floatUp 2s ease-out forwards}
@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-200px) scale(.3) rotate(20deg)}}
pre{white-space:pre-wrap;font-family:inherit}
/* Notes Panel */
.notes-overlay{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:300;display:none;opacity:0;transition:opacity .3s}
.notes-overlay.show{display:block;opacity:1}
.notes-panel{position:fixed;top:0;right:-100%;width:min(360px,88vw);height:100%;background:#FFF5F8;z-index:310;transition:right .3s ease;display:flex;flex-direction:column;box-shadow:-4px 0 20px rgba(0,0,0,.15)}
.notes-panel.show{right:0}
.notes-header{background:var(--header);color:#fff;padding:14px 16px;padding-top:max(14px,env(safe-area-inset-top));display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.notes-header h2{font-size:16px;font-weight:700}
.notes-body{flex:1;overflow-y:auto;padding:12px;-webkit-overflow-scrolling:touch}
.note-card{background:#fff;border-radius:12px;padding:12px 14px;margin-bottom:8px;box-shadow:0 1px 4px rgba(232,119,139,.12);cursor:pointer;transition:transform .15s}
.note-card:active{transform:scale(.97)}
.note-card .note-title{font-weight:600;font-size:14px;color:var(--text)}.note-card .note-meta{font-size:11px;color:var(--text-light);margin-top:4px}
.note-status{display:inline-block;font-size:11px;padding:1px 6px;border-radius:8px;margin-left:6px}
.note-status.editing{background:#FFE0E8;color:#D4566E}.note-status.confirmed{background:#E8F5E1;color:#2D5016}
.note-add-btn{width:100%;padding:12px;border:2px dashed var(--border);border-radius:12px;background:none;font-size:14px;color:var(--accent);cursor:pointer;margin-bottom:8px}
/* Note Detail */
.note-detail{display:none;flex-direction:column;height:100%}
.note-detail.show{display:flex}
.note-list-view{display:flex;flex-direction:column;height:100%}
.note-list-view.hide{display:none}
.note-items{flex:1;overflow-y:auto;padding:12px}
.note-item{display:flex;align-items:center;gap:8px;padding:8px 4px;border-bottom:1px solid var(--border)}
.note-item input[type=checkbox]{width:18px;height:18px;accent-color:var(--primary);flex-shrink:0}
.note-item .item-text{flex:1;font-size:14px}.note-item .item-text.checked{text-decoration:line-through;color:var(--text-light)}
.note-item .item-author{font-size:10px;color:var(--accent);flex-shrink:0}
.note-item .item-del{background:none;border:none;color:#ccc;font-size:16px;cursor:pointer;padding:2px 4px;flex-shrink:0}
.note-item .item-del:hover{color:#E8778B}
.note-add-item{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border);flex-shrink:0}
.note-add-item input{flex:1;border:1px solid var(--border);border-radius:20px;padding:8px 14px;font-size:14px;outline:none;background:#fff}
.note-add-item button{background:var(--primary);color:#fff;border:none;border-radius:50%;width:34px;height:34px;font-size:16px;cursor:pointer;flex-shrink:0}
.note-actions{display:flex;gap:8px;padding:8px 12px;border-top:1px solid var(--border);flex-shrink:0;flex-wrap:wrap}
.note-actions button{flex:1;padding:8px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer}
.note-btn-confirm{background:#E8F5E1;color:#2D5016}.note-btn-edit{background:#FFF3CD;color:#856404}.note-btn-delete{background:#FFE0E8;color:#D4566E}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-overlay" id="loginOverlay">
<div class="login-box">
  <h2>ğŸ’• ì—°ì¸ë°©</h2>
  <p>ë‘˜ë§Œì˜ ë¹„ë°€ ì±„íŒ…</p>
  <input id="loginName" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”">
  <button onclick="doLogin()">ì…ì¥í•˜ê¸° ğŸ’•</button>
</div>
</div>

<!-- CHAT -->
<div class="header">
  <div>
    <h1>ğŸ’• ì—°ì¸ë°©</h1>
    <div class="header-sub" id="ddayText"></div>
  </div>
  <div class="header-right">
    <span class="dday" id="onlineCount" style="background:rgba(255,255,255,.2);font-size:11px">ğŸ‘¤ 0</span>
    <span class="dday" id="ddayBadge"></span>
    <button class="btn-icon" onclick="openNotes()">ğŸ“</button>
    <button class="btn-icon" onclick="openSettings()">âš™ï¸</button>
  </div>
</div>
<div class="messages" id="messages"></div>
<div class="input-area">
  <label class="upload-btn">ğŸ“·<input type="file" hidden id="fileInput" accept="image/*,*/*" onchange="uploadFile()"></label>
  <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” ğŸ’•" onkeydown="if(event.key==='Enter')sendMsg()">
  <button class="send-btn" onclick="sendMsg()">ğŸ’Œ</button>
</div>

<!-- SETTINGS -->
<div class="modal-overlay" id="settingsModal">
<div class="modal">
  <h3>âš™ï¸ ì„¤ì •</h3>
  <label>API ì„œë²„ URL</label>
  <input id="settingsUrl">
  <label>ì‚¬ê·„ ë‚  (D-day)</label>
  <input type="date" id="settingsDate">
  <hr style="border:none;border-top:1px solid var(--border);margin:16px 0 12px">
  <button style="width:100%;padding:10px;background:#FF4D6D;color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer" onclick="resetChat()">ğŸ—‘ï¸ ì±„íŒ… ë¦¬ì…‹</button>
  <div style="text-align:right;margin-top:12px">
    <button class="btn-primary" onclick="saveSettings()">ì €ì¥</button>
    <button class="btn-cancel" onclick="closeSettings()">ì·¨ì†Œ</button>
  </div>
</div>
</div>

<!-- NOTES PANEL -->
<div class="notes-overlay" id="notesOverlay" onclick="closeNotes()"></div>
<div class="notes-panel" id="notesPanel">
  <!-- List View -->
  <div class="note-list-view" id="noteListView">
    <div class="notes-header">
      <h2>ğŸ“ ê³µìœ  ë©”ëª¨</h2>
      <button class="btn-icon" onclick="closeNotes()" style="color:#fff;font-size:20px">âœ•</button>
    </div>
    <div class="notes-body" id="noteListBody">
      <button class="note-add-btn" onclick="createNote()">â• ìƒˆ ë©”ëª¨ ë§Œë“¤ê¸°</button>
      <div id="noteList"></div>
    </div>
  </div>
  <!-- Detail View -->
  <div class="note-detail" id="noteDetailView">
    <div class="notes-header">
      <div style="display:flex;align-items:center;gap:8px">
        <button class="btn-icon" onclick="backToList()" style="color:#fff;font-size:18px">â†</button>
        <h2 id="noteDetailTitle">ë©”ëª¨</h2>
      </div>
      <span class="note-status" id="noteDetailStatus"></span>
    </div>
    <div class="note-items" id="noteItems"></div>
    <div class="note-add-item">
      <input id="noteItemInput" placeholder="í•­ëª© ì¶”ê°€..." onkeydown="if(event.key==='Enter')addNoteItem()">
      <button onclick="addNoteItem()">+</button>
    </div>
    <div class="note-actions">
      <button class="note-btn-confirm" id="noteConfirmBtn" onclick="toggleNoteStatus()">âœ… í™•ì •</button>
      <button class="note-btn-delete" onclick="deleteCurrentNote()">ğŸ—‘ï¸ ì‚­ì œ</button>
    </div>
  </div>
</div>

<script>
const ROOM = 'love';
let API_URL = localStorage.getItem('love_api_url') || 'https://basically-yearly-foo-statewide.trycloudflare.com';
let user = JSON.parse(localStorage.getItem('love_user') || 'null');
let anniversary = localStorage.getItem('love_anniversary') || '';
let lastTs = 0;
let pollTimer = null;
const msgEl = document.getElementById('messages');

// D-day
function updateDday() {
  if (!anniversary) { document.getElementById('ddayBadge').textContent = ''; document.getElementById('ddayText').textContent = 'ì‚¬ê·„ë‚ ì„ ì„¤ì •í•´ë³´ì„¸ìš” âš™ï¸'; return; }
  const start = new Date(anniversary);
  const now = new Date();
  const diff = Math.floor((now - start) / 86400000);
  document.getElementById('ddayBadge').textContent = `D+${diff}`;
  document.getElementById('ddayText').textContent = `${anniversary} ~`;
}
updateDday();

// Login
function doLogin() {
  const name = document.getElementById('loginName').value.trim();
  if (!name) return alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
  user = { sender: name };
  localStorage.setItem('love_user', JSON.stringify(user));
  document.getElementById('loginOverlay').style.display = 'none';
  addSystem(`${name}ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤ ğŸ’•`);
  startPolling();
}
if (user) { document.getElementById('loginOverlay').style.display = 'none'; startPolling(); }

// Settings
function openSettings() {
  document.getElementById('settingsUrl').value = API_URL;
  document.getElementById('settingsDate').value = anniversary;
  document.getElementById('settingsModal').classList.add('show');
}
function closeSettings() { document.getElementById('settingsModal').classList.remove('show'); }
function saveSettings() {
  const v = document.getElementById('settingsUrl').value.replace(/\/$/,'');
  if (v) { API_URL = v; localStorage.setItem('love_api_url', v); }
  const d = document.getElementById('settingsDate').value;
  if (d) { anniversary = d; localStorage.setItem('love_anniversary', d); updateDday(); }
  closeSettings();
}

// Floating heart
function spawnHeart(x, y) {
  const el = document.createElement('div');
  el.className = 'floating-heart';
  el.textContent = ['â¤ï¸','ğŸ’•','ğŸ’–','ğŸ’—','ğŸ’˜'][Math.floor(Math.random()*5)];
  el.style.left = x + 'px'; el.style.top = y + 'px';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2000);
}

// Messages
function addBubble(msg) {
  const isMe = msg.type === 'user' && msg.sender === user?.sender;
  const div = document.createElement('div');
  div.className = `msg ${msg.type === 'bot' ? 'bot' : isMe ? 'me' : 'other'}`;
  const t = new Date(msg.timestamp).toLocaleTimeString('ko',{hour:'2-digit',minute:'2-digit'});
  let html = '';
  if (!isMe && msg.type !== 'bot') html += `<div class="sender">${esc(msg.sender)}</div>`;
  if (msg.type === 'bot') html += `<div class="sender">í´ë¡œì´ ğŸ¤–</div>`;
  html += `<pre>${esc(msg.text)}</pre>`;
  if (msg.fileName && msg.filePath) html += `<a class="file-link" href="${API_URL}/api/download/${encodeURIComponent(msg.filePath)}" target="_blank">ğŸ“¥ ${esc(msg.fileName)}</a>`;
  else if (msg.fileName) html += `<span style="font-size:12px;color:var(--accent)">ğŸ“ ${esc(msg.fileName)}</span>`;
  html += `<div class="time">${t}</div>`;
  // Heart reaction button
  if (msg.type !== 'bot') html += `<span class="heart-btn" onclick="toggleHeart(this,event)">â™¡</span>`;
  div.innerHTML = html;
  // Double-tap heart
  let lastTap = 0;
  div.addEventListener('click', (e) => {
    const now = Date.now();
    if (now - lastTap < 300) { spawnHeart(e.clientX, e.clientY); }
    lastTap = now;
  });
  msgEl.appendChild(div);
}

function toggleHeart(el, e) {
  el.classList.toggle('active');
  el.textContent = el.classList.contains('active') ? 'â¤ï¸' : 'â™¡';
  if (el.classList.contains('active')) spawnHeart(e.clientX, e.clientY);
  e.stopPropagation();
}

function addSystem(text) {
  const div = document.createElement('div');
  div.className = 'system-msg';
  div.textContent = text;
  msgEl.appendChild(div);
  scrollBottom();
}

function scrollBottom() { requestAnimationFrame(() => msgEl.scrollTop = msgEl.scrollHeight); }
function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// API
async function sendMsg() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  try {
    await fetch(`${API_URL}/api/message`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ text, sender: user.sender, room: ROOM })
    });
    fetchMessages();
  } catch (e) { addSystem('âš ï¸ ì „ì†¡ ì‹¤íŒ¨'); }
}

async function uploadFile() {
  const file = document.getElementById('fileInput').files[0];
  if (!file) return;
  const fd = new FormData();
  fd.append('file', file);
  fd.append('sender', user.sender);
  fd.append('room', ROOM);
  try {
    addSystem('ğŸ“¤ ì—…ë¡œë“œ ì¤‘...');
    await fetch(`${API_URL}/api/upload`, { method: 'POST', body: fd });
    fetchMessages();
  } catch { addSystem('âš ï¸ ì—…ë¡œë“œ ì‹¤íŒ¨'); }
  document.getElementById('fileInput').value = '';
}

async function fetchMessages() {
  try {
    const res = await fetch(`${API_URL}/api/messages?room=${ROOM}&since=${lastTs}`);
    const data = await res.json();
    if (data.messages?.length) {
      data.messages.forEach(m => { addBubble(m); if (m.timestamp > lastTs) lastTs = m.timestamp; });
      scrollBottom();
    }
  } catch {}
}

async function resetChat() {
  if (!confirm('ì±„íŒ… ë‚´ìš©ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?')) return;
  try {
    await fetch(`${API_URL}/api/reset?room=${ROOM}`, { method: 'POST' });
    msgEl.innerHTML = '';
    lastTs = 0;
    addSystem('ğŸ’• ì±„íŒ…ì´ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeSettings();
  } catch { alert('ë¦¬ì…‹ ì‹¤íŒ¨ â€” ì„œë²„ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”'); }
}

async function sendHeartbeat() {
  try {
    const res = await fetch(`${API_URL}/api/heartbeat`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ room: ROOM, sender: user.sender })
    });
    const data = await res.json();
    document.getElementById('onlineCount').textContent = `ğŸ‘¤ ${data.count}`;
  } catch {}
}

function startPolling() {
  fetchMessages();
  sendHeartbeat();
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(() => { fetchMessages(); sendHeartbeat(); }, 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Notes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentNoteId = null;
let notesPollTimer = null;

function openNotes() {
  document.getElementById('notesOverlay').classList.add('show');
  document.getElementById('notesPanel').classList.add('show');
  backToList();
}
function closeNotes() {
  document.getElementById('notesOverlay').classList.remove('show');
  document.getElementById('notesPanel').classList.remove('show');
  if (notesPollTimer) { clearInterval(notesPollTimer); notesPollTimer = null; }
}
function backToList() {
  document.getElementById('noteListView').classList.remove('hide');
  document.getElementById('noteDetailView').classList.remove('show');
  currentNoteId = null;
  if (notesPollTimer) { clearInterval(notesPollTimer); notesPollTimer = null; }
  fetchNoteList();
}

async function fetchNoteList() {
  try {
    const res = await fetch(`${API_URL}/api/notes?room=${ROOM}`);
    const data = await res.json();
    const el = document.getElementById('noteList');
    if (!data.notes?.length) { el.innerHTML = '<p style="text-align:center;color:var(--text-light);padding:20px;font-size:13px">ì•„ì§ ë©”ëª¨ê°€ ì—†ì–´ìš” ğŸ’•</p>'; return; }
    el.innerHTML = data.notes.map(n => `<div class="note-card" onclick="openNoteDetail('${n.id}')">
      <span class="note-title">${esc(n.title)}</span>
      <span class="note-status ${n.status}">${n.status==='confirmed'?'âœ… í™•ì •':'âœï¸ ìˆ˜ì •ì¤‘'}</span>
      <div class="note-meta">${esc(n.creator)} Â· í•­ëª© ${n.itemCount}ê°œ</div>
    </div>`).join('');
  } catch {}
}

async function createNote() {
  const title = prompt('ë©”ëª¨ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” ğŸ’•');
  if (!title?.trim()) return;
  try {
    await fetch(`${API_URL}/api/notes`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ room: ROOM, title: title.trim(), creator: user.sender }) });
    fetchNoteList();
  } catch { alert('ìƒì„± ì‹¤íŒ¨'); }
}

async function openNoteDetail(id) {
  currentNoteId = id;
  document.getElementById('noteListView').classList.add('hide');
  document.getElementById('noteDetailView').classList.add('show');
  fetchNoteDetail();
  if (notesPollTimer) clearInterval(notesPollTimer);
  notesPollTimer = setInterval(fetchNoteDetail, 3000);
}

async function fetchNoteDetail() {
  if (!currentNoteId) return;
  try {
    const res = await fetch(`${API_URL}/api/notes/${currentNoteId}?room=${ROOM}`);
    const { note } = await res.json();
    document.getElementById('noteDetailTitle').textContent = note.title;
    const statusEl = document.getElementById('noteDetailStatus');
    statusEl.textContent = note.status === 'confirmed' ? 'âœ… í™•ì •' : 'âœï¸ ìˆ˜ì •ì¤‘';
    statusEl.className = `note-status ${note.status}`;
    const btn = document.getElementById('noteConfirmBtn');
    btn.textContent = note.status === 'confirmed' ? 'âœï¸ ìˆ˜ì •ëª¨ë“œ' : 'âœ… í™•ì •';
    btn.className = note.status === 'confirmed' ? 'note-btn-edit' : 'note-btn-confirm';
    const itemsEl = document.getElementById('noteItems');
    itemsEl.innerHTML = (note.items||[]).map((it,i) => `<div class="note-item">
      <input type="checkbox" ${it.checked?'checked':''} onchange="toggleItem(${i},this.checked)">
      <span class="item-text ${it.checked?'checked':''}">${esc(it.text)}</span>
      <span class="item-author">${esc(it.author)}</span>
      <button class="item-del" onclick="deleteItem(${i})">âœ•</button>
    </div>`).join('') || '<p style="text-align:center;color:var(--text-light);padding:20px;font-size:13px">í•­ëª©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>';
  } catch {}
}

async function updateNote(updates) {
  try {
    await fetch(`${API_URL}/api/notes/${currentNoteId}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ room: ROOM, ...updates }) });
    fetchNoteDetail();
  } catch {}
}

async function addNoteItem() {
  const input = document.getElementById('noteItemInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  try {
    const res = await fetch(`${API_URL}/api/notes/${currentNoteId}?room=${ROOM}`);
    const { note } = await res.json();
    const items = [...(note.items||[]), { text, checked: false, author: user.sender }];
    updateNote({ items });
  } catch {}
}

async function toggleItem(idx, checked) {
  try {
    const res = await fetch(`${API_URL}/api/notes/${currentNoteId}?room=${ROOM}`);
    const { note } = await res.json();
    if (note.items[idx]) note.items[idx].checked = checked;
    updateNote({ items: note.items });
  } catch {}
}

async function deleteItem(idx) {
  try {
    const res = await fetch(`${API_URL}/api/notes/${currentNoteId}?room=${ROOM}`);
    const { note } = await res.json();
    note.items.splice(idx, 1);
    updateNote({ items: note.items });
  } catch {}
}

async function toggleNoteStatus() {
  try {
    const res = await fetch(`${API_URL}/api/notes/${currentNoteId}?room=${ROOM}`);
    const { note } = await res.json();
    const newStatus = note.status === 'confirmed' ? 'editing' : 'confirmed';
    updateNote({ status: newStatus, confirmedBy: newStatus === 'confirmed' ? user.sender : null });
  } catch {}
}

async function deleteCurrentNote() {
  if (!confirm('ì´ ë©”ëª¨ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
  try {
    await fetch(`${API_URL}/api/notes/${currentNoteId}?room=${ROOM}`, { method:'DELETE' });
    backToList();
  } catch { alert('ì‚­ì œ ì‹¤íŒ¨'); }
}
</script>
</body>
</html>
