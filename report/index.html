<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë‘ë ˆìƒí˜‘ ì‚¬ì—…ë³´ê³  ìë£Œ ì œì¶œ</title>
<style>
:root {
  --green: #2d6a4f;
  --green-light: #40916c;
  --green-pale: #d8f3dc;
  --brown: #6b4226;
  --brown-light: #a67c52;
  --bg: #f5f1eb;
  --white: #ffffff;
  --gray: #e9ecef;
  --text: #2b2b2b;
  --text-light: #6c757d;
  --shadow: 0 2px 12px rgba(0,0,0,0.08);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: -apple-system, 'Pretendard', sans-serif; background: var(--bg); color: var(--text); height: 100dvh; display:flex; flex-direction:column; }
/* TEAM SELECT */
#team-select { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:24px; }
#team-select h1 { font-size:1.5rem; color:var(--green); margin-bottom:6px; }
#team-select p { color:var(--text-light); margin-bottom:28px; font-size:0.9rem; }
.team-grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; width:100%; max-width:360px; }
.team-btn { padding:18px 12px; border:none; border-radius:14px; background:var(--white); box-shadow:var(--shadow); cursor:pointer; transition:all .2s; text-align:center; }
.team-btn:active { transform:scale(0.96); }
.team-btn .name { font-size:1.05rem; font-weight:700; color:var(--green); }
.team-btn .person { font-size:0.8rem; color:var(--text-light); margin-top:4px; }
.team-btn:hover { background:var(--green-pale); }
/* CHAT */
#chat-screen { flex:1; display:none; flex-direction:column; height:100dvh; }
.chat-header { background:var(--green); color:#fff; padding:14px 16px; display:flex; align-items:center; gap:12px; flex-shrink:0; }
.chat-header .back { background:none; border:none; color:#fff; font-size:1.3rem; cursor:pointer; }
.chat-header .title { font-weight:700; font-size:1.05rem; }
.chat-header .sub { font-size:0.75rem; opacity:0.8; }
.chat-messages { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:10px; background:var(--bg); }
.msg { max-width:82%; padding:12px 16px; border-radius:18px; font-size:0.92rem; line-height:1.5; word-break:break-word; }
.msg.bot { align-self:flex-start; background:var(--white); box-shadow:0 1px 4px rgba(0,0,0,0.06); border-bottom-left-radius:4px; }
.msg.user { align-self:flex-end; background:var(--green); color:#fff; border-bottom-right-radius:4px; }
.msg .time { font-size:0.65rem; opacity:0.6; margin-top:4px; }
.msg .file-badge { display:inline-block; background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:8px; font-size:0.75rem; margin-top:4px; }
.msg.bot .file-badge { background:var(--green-pale); color:var(--green); }
/* INPUT */
.chat-input { flex-shrink:0; background:var(--white); border-top:1px solid var(--gray); padding:10px 12px; display:flex; gap:8px; align-items:flex-end; }
.chat-input textarea { flex:1; border:1px solid var(--gray); border-radius:20px; padding:10px 14px; font-size:0.92rem; resize:none; max-height:120px; font-family:inherit; outline:none; }
.chat-input textarea:focus { border-color:var(--green-light); }
.chat-input .btn-icon { width:40px; height:40px; border:none; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.btn-attach { background:var(--gray); color:var(--text-light); font-size:1.2rem; }
.btn-send { background:var(--green); color:#fff; font-size:1.1rem; }
.btn-send:disabled { opacity:0.4; }
.file-preview { font-size:0.78rem; color:var(--green); padding:0 8px 4px; }
.file-preview span { cursor:pointer; margin-left:6px; color:red; }
/* HISTORY TOGGLE */
.history-divider { text-align:center; font-size:0.75rem; color:var(--text-light); padding:8px; cursor:pointer; }
.history-divider:hover { color:var(--green); }
/* LOADING */
.typing { display:flex; gap:4px; padding:12px 16px; align-self:flex-start; }
.typing span { width:8px; height:8px; background:var(--green-light); border-radius:50%; animation:bounce .6s infinite alternate; }
.typing span:nth-child(2) { animation-delay:.2s; }
.typing span:nth-child(3) { animation-delay:.4s; }
@keyframes bounce { to { opacity:.3; transform:translateY(-4px); } }
</style>
</head>
<body>

<!-- TEAM SELECT -->
<div id="team-select">
  <h1>ğŸŒ¿ ë‘ë ˆìƒí˜‘</h1>
  <p>ì‚¬ì—…ë³´ê³  ìë£Œ ì œì¶œ</p>
  <div class="team-grid">
    <button class="team-btn" onclick="selectTeam('team01','ì¶•ìˆ˜ì‚°íŒ€','ìƒì˜')"><div class="name">ğŸ¥© ì¶•ìˆ˜ì‚°íŒ€</div><div class="person">ìƒì˜</div></button>
    <button class="team-btn" onclick="selectTeam('team02','ë†ì‚°íŒ€','ì •í˜„')"><div class="name">ğŸ¥¬ ë†ì‚°íŒ€</div><div class="person">ì •í˜„</div></button>
    <button class="team-btn" onclick="selectTeam('team03','ê°€ê³µíŒ€','ê¸°í˜„')"><div class="name">ğŸ«™ ê°€ê³µíŒ€</div><div class="person">ê¸°í˜„</div></button>
    <button class="team-btn" onclick="selectTeam('team04','ë§¤ì¥ì‚¬ì—…íŒ€','ì¸ì„œìš¸')"><div class="name">ğŸª ë§¤ì¥ì‚¬ì—…íŒ€</div><div class="person">ì¸ì„œìš¸</div></button>
    <button class="team-btn" onclick="selectTeam('team05','ì˜¨ë¼ì¸íŒ€','ì´ì§€ì›')"><div class="name">ğŸ’» ì˜¨ë¼ì¸íŒ€</div><div class="person">ì´ì§€ì›</div></button>
    <button class="team-btn" onclick="selectTeam('team06','ì‚¬ì—…ìƒë¬´','100ìƒë¬´ë‹˜')"><div class="name">ğŸ“Š ì‚¬ì—…ìƒë¬´</div><div class="person">100ìƒë¬´ë‹˜</div></button>
  </div>
</div>

<!-- CHAT -->
<div id="chat-screen">
  <div class="chat-header">
    <button class="back" onclick="goBack()">â†</button>
    <div>
      <div class="title" id="chat-title"></div>
      <div class="sub">ì‚¬ì—…ë³´ê³  ìë£Œ ì œì¶œ</div>
    </div>
  </div>
  <div class="chat-messages" id="messages"></div>
  <div class="file-preview" id="file-preview" style="display:none"></div>
  <div class="chat-input">
    <input type="file" id="file-input" style="display:none" multiple onchange="onFileSelect()">
    <button class="btn-icon btn-attach" onclick="document.getElementById('file-input').click()">ğŸ“</button>
    <textarea id="text-input" rows="1" placeholder="ìë£Œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." oninput="autoGrow(this);toggleSend()"></textarea>
    <button class="btn-icon btn-send" id="btn-send" disabled onclick="sendMessage()">â¤</button>
  </div>
</div>

<script>
// === CONFIG ===
const APPS_SCRIPT_URL = '%%APPS_SCRIPT_URL%%'; // ë°°í¬ í›„ êµì²´

let currentTeam = {};
let selectedFiles = [];
const STORAGE_KEY = 'dure_report_history';

function getHistory() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch { return {}; }
}
function saveToHistory(teamCode, entry) {
  const h = getHistory();
  if (!h[teamCode]) h[teamCode] = [];
  h[teamCode].push(entry);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(h));
}

function selectTeam(code, name, person) {
  currentTeam = { code, name, person };
  document.getElementById('chat-title').textContent = `${name} â€” ${person}`;
  document.getElementById('team-select').style.display = 'none';
  const cs = document.getElementById('chat-screen');
  cs.style.display = 'flex';
  renderChat();
}

function goBack() {
  document.getElementById('chat-screen').style.display = 'none';
  document.getElementById('team-select').style.display = 'flex';
  selectedFiles = [];
  document.getElementById('file-input').value = '';
  document.getElementById('file-preview').style.display = 'none';
}

function renderChat() {
  const box = document.getElementById('messages');
  box.innerHTML = '';
  addBotMsg('ì•ˆë…•í•˜ì„¸ìš”! ğŸ“‹\nì‚¬ì—…ë³´ê³ ì— í•„ìš”í•œ ìë£Œë¥¼ ë³´ë‚´ì£¼ì„¸ìš”.\ní…ìŠ¤íŠ¸ ì…ë ¥ê³¼ íŒŒì¼ ì²¨ë¶€ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
  const history = (getHistory()[currentTeam.code] || []);
  if (history.length) {
    const div = document.createElement('div');
    div.className = 'history-divider';
    div.textContent = `ğŸ“œ ì´ì „ ì œì¶œ ë‚´ì—­ ${history.length}ê±´ ë³´ê¸°`;
    div.onclick = () => { showHistory(history, div); };
    box.appendChild(div);
  }
  scrollBottom();
}

function showHistory(list, divEl) {
  divEl.style.display = 'none';
  const box = document.getElementById('messages');
  list.forEach(e => {
    const m = document.createElement('div');
    m.className = 'msg user';
    let t = e.text || '';
    if (e.files) t += `\nğŸ“ íŒŒì¼ ${e.files}ê°œ`;
    m.innerHTML = esc(t) + `<div class="time">${e.date}</div>`;
    box.insertBefore(m, divEl.nextSibling);
    const r = document.createElement('div');
    r.className = 'msg bot';
    r.textContent = 'âœ… ì ‘ìˆ˜ ì™„ë£Œ';
    box.insertBefore(r, m.nextSibling);
  });
  scrollBottom();
}

function addBotMsg(text) {
  const box = document.getElementById('messages');
  const m = document.createElement('div');
  m.className = 'msg bot';
  m.innerHTML = esc(text);
  box.appendChild(m);
  scrollBottom();
}
function addUserMsg(text, fileCount) {
  const box = document.getElementById('messages');
  const m = document.createElement('div');
  m.className = 'msg user';
  let html = esc(text);
  if (fileCount) html += `<div class="file-badge">ğŸ“ íŒŒì¼ ${fileCount}ê°œ ì²¨ë¶€</div>`;
  const now = new Date();
  html += `<div class="time">${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}</div>`;
  m.innerHTML = html;
  box.appendChild(m);
  scrollBottom();
}
function addTyping() {
  const box = document.getElementById('messages');
  const d = document.createElement('div');
  d.className = 'typing';
  d.id = 'typing';
  d.innerHTML = '<span></span><span></span><span></span>';
  box.appendChild(d);
  scrollBottom();
}
function removeTyping() { document.getElementById('typing')?.remove(); }

function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }
function scrollBottom() { const b=document.getElementById('messages'); setTimeout(()=>b.scrollTop=b.scrollHeight,50); }
function autoGrow(el) { el.style.height='auto'; el.style.height=el.scrollHeight+'px'; }
function toggleSend() { document.getElementById('btn-send').disabled = !(document.getElementById('text-input').value.trim() || selectedFiles.length); }

function onFileSelect() {
  const fi = document.getElementById('file-input');
  selectedFiles = [...fi.files];
  const fp = document.getElementById('file-preview');
  if (selectedFiles.length) {
    fp.style.display = 'block';
    fp.innerHTML = selectedFiles.map(f=>f.name).join(', ') + ' <span onclick="clearFiles()">âœ•</span>';
  } else { fp.style.display='none'; }
  toggleSend();
}
function clearFiles() {
  selectedFiles = [];
  document.getElementById('file-input').value = '';
  document.getElementById('file-preview').style.display = 'none';
  toggleSend();
}

async function sendMessage() {
  const text = document.getElementById('text-input').value.trim();
  if (!text && !selectedFiles.length) return;
  addUserMsg(text || '(íŒŒì¼ ì²¨ë¶€)', selectedFiles.length);
  const fileCount = selectedFiles.length;
  document.getElementById('text-input').value = '';
  autoGrow(document.getElementById('text-input'));
  document.getElementById('file-preview').style.display = 'none';
  toggleSend();
  addTyping();

  try {
    const fd = new FormData();
    fd.append('teamCode', currentTeam.code);
    fd.append('teamName', currentTeam.name);
    fd.append('person', currentTeam.person);
    fd.append('text', text);
    selectedFiles.forEach(f => fd.append('file', f));

    const res = await fetch(APPS_SCRIPT_URL, { method:'POST', body: fd });
    removeTyping();
    if (res.ok) {
      addBotMsg('âœ… ì ‘ìˆ˜ ì™„ë£Œ!\nìë£Œê°€ ì •ìƒì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.');
      saveToHistory(currentTeam.code, { text, files: fileCount, date: new Date().toLocaleString('ko-KR') });
    } else {
      addBotMsg('âš ï¸ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    }
  } catch(e) {
    removeTyping();
    addBotMsg('âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì…ë‹ˆë‹¤.\nì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
  }
  selectedFiles = [];
  document.getElementById('file-input').value = '';
}

// Enter to send
document.getElementById('text-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});
</script>
</body>
</html>
