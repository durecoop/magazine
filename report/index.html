<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë‘ë ˆìƒí˜‘ ì‚¬ì—…ë³´ê³  ì±„íŒ…ë°©</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒ¿</text></svg>">
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--green:#2D5016;--beige:#F5F0E8;--brown:#8B7355;--light-green:#E8F5E1;--my-bubble:#D4EDC9;--bot-bubble:#F0F8E8;--other-bubble:#fff}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans KR',sans-serif;background:var(--beige);height:100vh;height:100dvh;display:flex;flex-direction:column;overflow:hidden}
#loginScreen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:20px;background:linear-gradient(135deg,#2D5016 0%,#4a7a2e 100%)}
#loginScreen h1{color:#fff;font-size:1.6em;margin-bottom:6px;text-shadow:0 2px 4px rgba(0,0,0,.2)}
#loginScreen p{color:rgba(255,255,255,.85);font-size:.9em;margin-bottom:30px}
.team-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;max-width:400px}
.team-card{background:rgba(255,255,255,.95);border-radius:16px;padding:18px 14px;text-align:center;cursor:pointer;transition:all .2s;border:3px solid transparent;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.team-card:hover,.team-card:active{transform:scale(1.03);border-color:var(--green);box-shadow:0 4px 16px rgba(45,80,22,.3)}
.team-card .emoji{font-size:2em;margin-bottom:6px}
.team-card .team-name{font-weight:700;color:var(--green);font-size:1em}
.team-card .person{color:var(--brown);font-size:.85em;margin-top:2px}
#chatScreen{display:none;flex-direction:column;height:100%}
.chat-header{background:var(--green);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.chat-header .title{font-size:1.05em;font-weight:700}
.chat-header .subtitle{font-size:.75em;opacity:.8;margin-top:2px}
.header-left{display:flex;align-items:center;gap:10px}
.back-btn{background:none;border:none;color:#fff;font-size:1.3em;cursor:pointer;padding:4px}
.progress-bar{background:rgba(255,255,255,.12);padding:8px 16px;display:flex;gap:6px;flex-wrap:wrap;flex-shrink:0;border-bottom:1px solid rgba(255,255,255,.1)}
.progress-item{font-size:.78em;background:rgba(255,255,255,.15);padding:3px 8px;border-radius:10px;white-space:nowrap}
.progress-item.done{background:rgba(212,237,201,.3);color:#D4EDC9}
.progress-item.pending{opacity:.6}
.messages{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:8px;-webkit-overflow-scrolling:touch;scroll-behavior:smooth}
.msg-row{display:flex;align-items:flex-end;gap:6px;max-width:85%}
.msg-row.mine{align-self:flex-end;flex-direction:row-reverse}
.msg-row.other{align-self:flex-start}
.msg-row.bot{align-self:flex-start}
.avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.85em;flex-shrink:0;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.msg-row.mine .avatar{display:none}
.bubble{padding:10px 14px;border-radius:16px;font-size:.92em;line-height:1.5;word-break:break-word;position:relative;box-shadow:0 1px 2px rgba(0,0,0,.06)}
.msg-row.mine .bubble{background:var(--my-bubble);border-bottom-right-radius:4px;color:#1a3a0a}
.msg-row.other .bubble{background:var(--other-bubble);border-bottom-left-radius:4px;color:#333}
.msg-row.bot .bubble{background:var(--bot-bubble);border-bottom-left-radius:4px;color:#2D5016;border:1px solid #c5e1b5}
.sender-name{font-size:.75em;font-weight:700;color:var(--brown);margin-bottom:3px}
.msg-time{font-size:.65em;color:#999;margin-top:3px;text-align:right}
.file-card{background:rgba(45,80,22,.08);border:1px solid rgba(45,80,22,.2);border-radius:10px;padding:10px 12px;margin-top:6px;display:flex;align-items:center;gap:8px}
.file-card .file-icon{font-size:1.5em}
.file-card .file-info{flex:1;min-width:0}
.file-card .file-name{font-size:.82em;font-weight:600;color:var(--green);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.file-card .file-size{font-size:.7em;color:#999}
.report-btn{display:inline-block;background:var(--green);color:#fff;border:none;padding:10px 20px;border-radius:12px;font-size:.88em;cursor:pointer;margin-top:8px;text-decoration:none;font-weight:600}
.report-btn:active{opacity:.7}
.input-area{background:#fff;padding:8px 12px;display:flex;align-items:flex-end;gap:8px;flex-shrink:0;border-top:1px solid #e0d8cc;padding-bottom:max(8px,env(safe-area-inset-bottom))}
.input-area textarea{flex:1;border:1px solid #ddd;border-radius:20px;padding:10px 14px;font-size:.92em;resize:none;max-height:100px;min-height:40px;line-height:1.4;font-family:inherit;outline:none}
.input-area textarea:focus{border-color:var(--green)}
.input-area button{width:40px;height:40px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.2em;flex-shrink:0;transition:background .2s}
.attach-btn{background:var(--beige);color:var(--brown)}
.send-btn{background:var(--green);color:#fff}
.send-btn:active,.attach-btn:active{opacity:.7}
#fileInput{display:none}
.system-msg{text-align:center;font-size:.78em;color:#999;padding:4px 0}
.typing{align-self:flex-start;display:flex;align-items:center;gap:6px;padding:4px 0}
.typing .dots{display:flex;gap:3px}
.typing .dots span{width:6px;height:6px;border-radius:50%;background:#999;animation:blink 1.4s infinite both}
.typing .dots span:nth-child(2){animation-delay:.2s}
.typing .dots span:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}
.connection-badge{position:fixed;top:60px;right:10px;padding:3px 10px;border-radius:10px;font-size:.7em;font-weight:700;z-index:100;opacity:.85}
.connection-badge.ok{background:#4caf50;color:#fff}
.connection-badge.err{background:#f44336;color:#fff}
@media(min-width:600px){.team-grid{grid-template-columns:1fr 1fr 1fr}.messages{max-width:700px;margin:0 auto;width:100%}.input-area{max-width:700px;margin:0 auto;width:100%}}
</style>
</head>
<body>

<div id="loginScreen">
  <h1>ğŸŒ¿ ë‘ë ˆìƒí˜‘ ì‚¬ì—…ë³´ê³ </h1>
  <p>íŒ€ì„ ì„ íƒí•´ ì±„íŒ…ë°©ì— ì…ì¥í•˜ì„¸ìš”</p>
  <div class="team-grid" id="teamGrid"></div>
</div>

<div id="chatScreen">
  <div class="chat-header">
    <div class="header-left">
      <button class="back-btn" onclick="logout()">â†</button>
      <div>
        <div class="title">ğŸŒ¿ ì‚¬ì—…ë³´ê³  ì±„íŒ…ë°©</div>
        <div class="subtitle" id="onlineStatus">ì ‘ì† ì¤‘</div>
      </div>
    </div>
  </div>
  <div class="progress-bar" id="progressBar"></div>
  <div class="messages" id="messages"></div>
  <div class="input-area">
    <button class="attach-btn" onclick="document.getElementById('fileInput').click()">ğŸ“</button>
    <input type="file" id="fileInput" accept=".xlsx,.xls,.doc,.docx,.pdf,.hwp,.ppt,.pptx,.txt,.csv,.jpg,.jpeg,.png,.gif,.zip" onchange="handleFile(event)">
    <textarea id="msgInput" rows="1" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
    <button class="send-btn" onclick="sendMessage()">â¤</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” Cloudflare Tunnel URL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_URL = 'https://basically-yearly-foo-statewide.trycloudflare.com';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Team Data
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TEAMS = [
  { id: 'livestock', team: 'ì¶•ìˆ˜ì‚°íŒ€', name: 'ìƒì˜', emoji: 'ğŸ¥©' },
  { id: 'agri', team: 'ë†ì‚°íŒ€', name: 'ì •í˜„', emoji: 'ğŸŒ¾' },
  { id: 'processed', team: 'ê°€ê³µíŒ€', name: 'ê¸°í˜„', emoji: 'ğŸ­' },
  { id: 'store', team: 'ë§¤ì¥ì‚¬ì—…íŒ€', name: 'ì¸ì„œìš¸', emoji: 'ğŸª' },
  { id: 'online', team: 'ì˜¨ë¼ì¸íŒ€', name: 'ì´ì§€ì›', emoji: 'ğŸ’»' },
  { id: 'exec', team: 'ì‚¬ì—…ìƒë¬´', name: '100ìƒë¬´ë‹˜', emoji: 'ğŸ‘”' }
];

let currentUser = null;
let lastTimestamp = 0;
let pollTimer = null;
let renderedIds = new Set();
const BOT_NAME = 'ì‹­í˜•í˜¸ ğŸ§ ';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Connection check
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkConnection() {
  try {
    const r = await fetch(API_URL + '/api/health', { signal: AbortSignal.timeout(5000) });
    if (r.ok) { showBadge('ok', 'ğŸŸ¢ ì—°ê²°ë¨'); return true; }
  } catch {}
  showBadge('err', 'ğŸ”´ ì„œë²„ ì˜¤í”„ë¼ì¸');
  return false;
}

function showBadge(cls, text) {
  let b = document.querySelector('.connection-badge');
  if (!b) { b = document.createElement('div'); b.className = 'connection-badge'; document.body.appendChild(b); }
  b.className = 'connection-badge ' + cls;
  b.textContent = text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Login
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildLoginScreen() {
  const grid = document.getElementById('teamGrid');
  TEAMS.forEach(t => {
    const card = document.createElement('div');
    card.className = 'team-card';
    card.innerHTML = `<div class="emoji">${t.emoji}</div><div class="team-name">${t.team}</div><div class="person">${t.name}</div>`;
    card.onclick = () => login(t);
    grid.appendChild(card);
  });
}

function login(team) {
  currentUser = team;
  localStorage.setItem('dure-chat-user', JSON.stringify(team));
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('chatScreen').style.display = 'flex';
  document.getElementById('onlineStatus').textContent = `${team.team} ${team.name} ì ‘ì† ì¤‘`;
  checkConnection();
  loadMessages();
  startPolling();
  updateProgress();
}

function logout() {
  currentUser = null;
  localStorage.removeItem('dure-chat-user');
  stopPolling();
  renderedIds.clear();
  lastTimestamp = 0;
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('chatScreen').style.display = 'none';
  document.getElementById('messages').innerHTML = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Polling for messages
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startPolling() {
  stopPolling();
  pollTimer = setInterval(pollMessages, 3000);
}
function stopPolling() { if (pollTimer) clearInterval(pollTimer); pollTimer = null; }

async function pollMessages() {
  try {
    const r = await fetch(`${API_URL}/api/messages?since=${lastTimestamp}`);
    const data = await r.json();
    if (data.messages && data.messages.length) {
      data.messages.forEach(m => {
        if (!renderedIds.has(m.id)) {
          renderMessage(m);
          renderedIds.add(m.id);
          if (m.timestamp > lastTimestamp) lastTimestamp = m.timestamp;
        }
      });
    }
  } catch {}
}

async function loadMessages() {
  try {
    const r = await fetch(`${API_URL}/api/messages?since=0`);
    const data = await r.json();
    if (data.messages) {
      data.messages.forEach(m => {
        if (!renderedIds.has(m.id)) {
          renderMessage(m);
          renderedIds.add(m.id);
          if (m.timestamp > lastTimestamp) lastTimestamp = m.timestamp;
        }
      });
    }
  } catch {
    addLocalMsg('system', 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Render
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMessage(msg) {
  const container = document.getElementById('messages');
  if (msg.type === 'system') {
    const div = document.createElement('div');
    div.className = 'system-msg';
    div.textContent = msg.text;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    return;
  }
  const isMine = currentUser && msg.sender === currentUser.name && msg.team === currentUser.team && msg.type === 'user';
  const isBot = msg.type === 'bot';
  const row = document.createElement('div');
  row.className = `msg-row ${isMine ? 'mine' : isBot ? 'bot' : 'other'}`;
  const avatarEmoji = isBot ? 'ğŸ§ ' : (TEAMS.find(t => t.name === msg.sender)?.emoji || 'ğŸ‘¤');

  let fileHtml = '';
  if (msg.fileName) {
    const icon = getFileIcon(msg.fileName);
    fileHtml = `<div class="file-card"><div class="file-icon">${icon}</div><div class="file-info"><div class="file-name">${esc(msg.fileName)}</div></div></div>`;
  }

  let reportHtml = '';
  if (msg.hasReport) {
    reportHtml = `<div style="margin-top:8px">
      <a class="report-btn" href="${API_URL}/api/report?format=html" target="_blank">ğŸ“‹ HTML ë³´ê³ ì„œ</a>
      <a class="report-btn" style="background:var(--brown);margin-left:6px" href="${API_URL}/api/report?format=xlsx" target="_blank">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</a></div>`;
  }

  const time = new Date(msg.timestamp).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
  row.innerHTML = `
    <div class="avatar">${avatarEmoji}</div>
    <div class="bubble">
      ${!isMine ? `<div class="sender-name">${esc(msg.sender)}${msg.team && !isBot ? ' Â· '+esc(msg.team):''}</div>` : ''}
      <div>${formatText(msg.text||'')}</div>
      ${fileHtml}${reportHtml}
      <div class="msg-time">${time}</div>
    </div>`;
  container.appendChild(row);
  container.scrollTop = container.scrollHeight;
}

function addLocalMsg(type, text) {
  const container = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'system-msg';
  div.textContent = text;
  container.appendChild(div);
}

function showTyping() {
  const container = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'typing';
  div.id = 'typingIndicator';
  div.innerHTML = `<div class="avatar">ğŸ§ </div><div class="dots"><span></span><span></span><span></span></div>`;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}
function hideTyping() {
  const el = document.getElementById('typingIndicator');
  if (el) el.remove();
}

function formatText(t) { return esc(t).replace(/\n/g,'<br>'); }
function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function getFileIcon(name) {
  const ext = (name.split('.').pop()||'').toLowerCase();
  const icons = {xlsx:'ğŸ“Š',xls:'ğŸ“Š',csv:'ğŸ“Š',doc:'ğŸ“',docx:'ğŸ“',hwp:'ğŸ“',pdf:'ğŸ“•',ppt:'ğŸ“™',pptx:'ğŸ“™',txt:'ğŸ“„',jpg:'ğŸ–¼ï¸',jpeg:'ğŸ–¼ï¸',png:'ğŸ–¼ï¸',gif:'ğŸ–¼ï¸',zip:'ğŸ“¦'};
  return icons[ext]||'ğŸ“„';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Send Message
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendMessage() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text || !currentUser) return;
  input.value = '';
  autoResize(input);

  showTyping();
  try {
    const r = await fetch(API_URL + '/api/message', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        text,
        sender: currentUser.name,
        team: currentUser.team,
        teamId: currentUser.id
      })
    });
    const data = await r.json();
    hideTyping();
    // Messages will appear via polling, but render bot response immediately
    if (data.message && !renderedIds.has(data.message.id)) {
      renderMessage(data.message);
      renderedIds.add(data.message.id);
      if (data.message.timestamp > lastTimestamp) lastTimestamp = data.message.timestamp;
    }
    updateProgress();
  } catch (err) {
    hideTyping();
    addLocalMsg('system', 'âš ï¸ ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// File Upload
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function handleFile(e) {
  const file = e.target.files[0];
  if (!file || !currentUser) return;
  e.target.value = '';

  if (file.size > 10 * 1024 * 1024) {
    addLocalMsg('system', 'âš ï¸ íŒŒì¼ í¬ê¸°ê°€ 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.');
    return;
  }

  showTyping();
  try {
    const fd = new FormData();
    fd.append('file', file);
    fd.append('sender', currentUser.name);
    fd.append('team', currentUser.team);
    fd.append('teamId', currentUser.id);

    const r = await fetch(API_URL + '/api/upload', { method: 'POST', body: fd });
    const data = await r.json();
    hideTyping();
    if (data.message && !renderedIds.has(data.message.id)) {
      renderMessage(data.message);
      renderedIds.add(data.message.id);
      if (data.message.timestamp > lastTimestamp) lastTimestamp = data.message.timestamp;
    }
    updateProgress();
  } catch {
    hideTyping();
    addLocalMsg('system', 'âš ï¸ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨.');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Progress
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function updateProgress() {
  try {
    const r = await fetch(API_URL + '/api/status');
    const data = await r.json();
    const bar = document.getElementById('progressBar');
    if (!bar) return;
    bar.innerHTML = '';
    data.teams.forEach(t => {
      const item = document.createElement('span');
      item.className = `progress-item ${t.submitted ? 'done' : 'pending'}`;
      item.textContent = `${t.submitted ? 'âœ…' : 'â¬œ'} ${t.team}`;
      bar.appendChild(item);
    });
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
buildLoginScreen();
const saved = localStorage.getItem('dure-chat-user');
if (saved) { try { login(JSON.parse(saved)); } catch {} }
</script>
</body>
</html>
