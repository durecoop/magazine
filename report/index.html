<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë‘ë ˆìƒí˜‘ ì‚¬ì—…ë³´ê³  ì±„íŒ…ë°©</title>
<style>
:root {
  --green: #2D5016;
  --green-light: #4a7a2e;
  --beige: #F5F0E8;
  --beige-dark: #E8DFD0;
  --brown: #5C3D2E;
  --brown-light: #8B6914;
  --white: #FFFFFF;
  --gray: #999;
  --bubble-mine: #DCF8C6;
  --bubble-other: #FFFFFF;
  --bubble-bot: #FFF9E6;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--beige); height: 100vh; height: 100dvh; overflow: hidden; }

/* ===== Team Select Screen ===== */
#teamSelect {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  height: 100vh; height: 100dvh; padding: 20px; background: linear-gradient(135deg, var(--green) 0%, var(--green-light) 100%);
}
#teamSelect h1 { color: var(--white); font-size: 24px; margin-bottom: 8px; }
#teamSelect p { color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 30px; }
.team-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; max-width: 360px; }
.team-btn {
  background: var(--white); border: none; border-radius: 16px; padding: 18px 12px;
  font-size: 15px; font-weight: 600; color: var(--green); cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.team-btn:active { transform: scale(0.96); }
.team-btn .emoji { font-size: 28px; display: block; margin-bottom: 6px; }
.team-btn .name { font-size: 12px; color: var(--gray); margin-top: 2px; }

/* ===== Chat Screen ===== */
#chatScreen { display: none; flex-direction: column; height: 100vh; height: 100dvh; }

/* Header */
.chat-header {
  background: var(--green); color: var(--white); padding: 12px 16px;
  display: flex; align-items: center; gap: 12px; flex-shrink: 0;
}
.chat-header .back { background: none; border: none; color: var(--white); font-size: 22px; cursor: pointer; padding: 4px; }
.chat-header .title { flex: 1; }
.chat-header .title h2 { font-size: 16px; font-weight: 600; }
.chat-header .title span { font-size: 11px; opacity: 0.8; }

/* Status Bar */
.status-bar {
  background: var(--beige-dark); padding: 10px 16px; flex-shrink: 0;
  display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--brown);
}
.status-dots { display: flex; gap: 4px; }
.status-dot {
  width: 22px; height: 22px; border-radius: 50%; background: #ccc;
  display: flex; align-items: center; justify-content: center; font-size: 10px; color: var(--white); font-weight: 700;
  transition: background 0.3s;
}
.status-dot.done { background: var(--green); }
.status-text { margin-left: auto; font-weight: 600; }

/* Messages */
.messages {
  flex: 1; overflow-y: auto; padding: 12px 16px; display: flex; flex-direction: column; gap: 6px;
  background: var(--beige); -webkit-overflow-scrolling: touch;
}
.msg-group { display: flex; flex-direction: column; gap: 2px; margin-bottom: 4px; }
.msg-sender { font-size: 12px; font-weight: 600; color: var(--brown); margin-left: 4px; margin-bottom: 2px; }
.msg-row { display: flex; align-items: flex-end; gap: 6px; }
.msg-row.mine { flex-direction: row-reverse; }
.msg-bubble {
  max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.5;
  word-break: break-word; position: relative;
}
.msg-row:not(.mine):not(.bot) .msg-bubble { background: var(--bubble-other); border-top-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
.msg-row.mine .msg-bubble { background: var(--bubble-mine); border-top-right-radius: 4px; }
.msg-row.bot .msg-bubble { background: var(--bubble-bot); border-top-left-radius: 4px; border: 1px solid #F0E6C8; }
.msg-time { font-size: 10px; color: var(--gray); white-space: nowrap; flex-shrink: 0; }
.msg-file { display: flex; align-items: center; gap: 6px; padding: 6px 0 2px; font-size: 13px; color: var(--green); }
.msg-file a { color: var(--green); text-decoration: underline; }
.msg-system {
  text-align: center; font-size: 12px; color: var(--gray); background: rgba(0,0,0,0.04);
  padding: 4px 12px; border-radius: 12px; align-self: center; margin: 6px 0;
}
.status-table { width: 100%; font-size: 13px; border-collapse: collapse; margin-top: 6px; }
.status-table td { padding: 3px 8px; }
.status-table .check { color: var(--green); font-weight: bold; }
.status-table .pending { color: var(--gray); }

/* Input */
.chat-input {
  background: var(--white); border-top: 1px solid var(--beige-dark); padding: 8px 12px;
  display: flex; align-items: flex-end; gap: 8px; flex-shrink: 0;
}
.chat-input .file-btn {
  background: none; border: none; font-size: 22px; cursor: pointer; color: var(--gray); padding: 6px;
}
.chat-input textarea {
  flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 10px 14px; font-size: 14px;
  resize: none; max-height: 100px; min-height: 40px; outline: none; font-family: inherit;
  line-height: 1.4;
}
.chat-input textarea:focus { border-color: var(--green); }
.chat-input .send-btn {
  background: var(--green); border: none; color: var(--white); width: 40px; height: 40px;
  border-radius: 50%; font-size: 18px; cursor: pointer; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
}
.chat-input .send-btn:disabled { background: #ccc; }
.file-preview {
  background: var(--beige); padding: 6px 12px; font-size: 12px; color: var(--brown);
  display: none; align-items: center; gap: 8px; flex-shrink: 0;
}
.file-preview .remove { cursor: pointer; color: red; font-weight: bold; }
</style>
</head>
<body>

<!-- ===== Team Selection ===== -->
<div id="teamSelect">
  <h1>ğŸŒ¿ ë‘ë ˆìƒí˜‘</h1>
  <p>ì‚¬ì—…ë³´ê³  ìë£Œ ì œì¶œ ì±„íŒ…ë°©</p>
  <div class="team-grid">
    <button class="team-btn" onclick="joinChat('team01')"><span class="emoji">ğŸ„</span>ì¶•ìˆ˜ì‚°íŒ€<div class="name">ìƒì˜</div></button>
    <button class="team-btn" onclick="joinChat('team02')"><span class="emoji">ğŸŒ¾</span>ë†ì‚°íŒ€<div class="name">ì •í˜„</div></button>
    <button class="team-btn" onclick="joinChat('team03')"><span class="emoji">ğŸ­</span>ê°€ê³µíŒ€<div class="name">ê¸°í˜„</div></button>
    <button class="team-btn" onclick="joinChat('team04')"><span class="emoji">ğŸª</span>ë§¤ì¥ì‚¬ì—…íŒ€<div class="name">ì¸ì„œìš¸</div></button>
    <button class="team-btn" onclick="joinChat('team05')"><span class="emoji">ğŸ’»</span>ì˜¨ë¼ì¸íŒ€<div class="name">ì´ì§€ì›</div></button>
    <button class="team-btn" onclick="joinChat('team06')"><span class="emoji">ğŸ“Š</span>ì‚¬ì—…ìƒë¬´<div class="name">100ìƒë¬´ë‹˜</div></button>
  </div>
</div>

<!-- ===== Chat Room ===== -->
<div id="chatScreen">
  <div class="chat-header">
    <button class="back" onclick="leaveChat()">â†</button>
    <div class="title">
      <h2>ğŸŒ¿ ì‚¬ì—…ë³´ê³  ì±„íŒ…ë°©</h2>
      <span id="headerSub">ì°¸ì—¬ì 0ëª…</span>
    </div>
  </div>
  <div class="status-bar">
    <span>ì œì¶œ í˜„í™©</span>
    <div class="status-dots" id="statusDots"></div>
    <span class="status-text" id="statusText">0/6</span>
  </div>
  <div class="messages" id="messages"></div>
  <div class="file-preview" id="filePreview">
    ğŸ“ <span id="fileName"></span> <span class="remove" onclick="removeFile()">âœ•</span>
  </div>
  <div class="chat-input">
    <button class="file-btn" onclick="document.getElementById('fileInput').click()">ğŸ“</button>
    <input type="file" id="fileInput" style="display:none" onchange="handleFile(this)">
    <textarea id="msgInput" rows="1" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
    <button class="send-btn" id="sendBtn" onclick="sendMessage()">â¤</button>
  </div>
</div>

<script>
// ===== Firebase Config (ë‚˜ì¤‘ì— ì—°ê²°) =====
const FIREBASE_CONFIG = {
  apiKey: "",
  authDomain: "",
  databaseURL: "",
  projectId: "",
  storageBucket: "",
  messagingSenderId: "",
  appId: ""
};
const USE_FIREBASE = FIREBASE_CONFIG.apiKey !== "";

// ===== Google Apps Script URL =====
const GAS_URL = ""; // ë°°í¬ í›„ URL ì…ë ¥

// ===== Teams =====
const TEAMS = {
  team01: { name: 'ì¶•ìˆ˜ì‚°íŒ€', person: 'ìƒì˜', emoji: 'ğŸ„' },
  team02: { name: 'ë†ì‚°íŒ€', person: 'ì •í˜„', emoji: 'ğŸŒ¾' },
  team03: { name: 'ê°€ê³µíŒ€', person: 'ê¸°í˜„', emoji: 'ğŸ­' },
  team04: { name: 'ë§¤ì¥ì‚¬ì—…íŒ€', person: 'ì¸ì„œìš¸', emoji: 'ğŸª' },
  team05: { name: 'ì˜¨ë¼ì¸íŒ€', person: 'ì´ì§€ì›', emoji: 'ğŸ’»' },
  team06: { name: 'ì‚¬ì—…ìƒë¬´', person: '100ìƒë¬´ë‹˜', emoji: 'ğŸ“Š' }
};

let currentUser = null;
let pendingFile = null;
let submittedTeams = new Set();
let db = null; // Firebase ref
let messagesRef = null;

// ===== Firebase Init =====
function initFirebase() {
  if (!USE_FIREBASE) return false;
  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.database();
    messagesRef = db.ref('chatroom/messages');
    return true;
  } catch(e) { console.warn('Firebase init failed, using local mode', e); return false; }
}

// ===== Local Storage Fallback =====
const LS_KEY = 'dure_chat_messages';
const LS_SUBMIT_KEY = 'dure_submitted';

function lsGetMessages() {
  try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch { return []; }
}
function lsSaveMessage(msg) {
  const msgs = lsGetMessages();
  msgs.push(msg);
  localStorage.setItem(LS_KEY, JSON.stringify(msgs));
}
function lsGetSubmitted() {
  try { return new Set(JSON.parse(localStorage.getItem(LS_SUBMIT_KEY) || '[]')); } catch { return new Set(); }
}
function lsSaveSubmitted(set) {
  localStorage.setItem(LS_SUBMIT_KEY, JSON.stringify([...set]));
}

// ===== Polling for local mode =====
let lastMsgCount = 0;
let pollTimer = null;

function startLocalPoll() {
  pollTimer = setInterval(() => {
    const msgs = lsGetMessages();
    if (msgs.length > lastMsgCount) {
      for (let i = lastMsgCount; i < msgs.length; i++) renderMessage(msgs[i]);
      lastMsgCount = msgs.length;
    }
    // Sync submitted
    submittedTeams = lsGetSubmitted();
    updateStatusBar();
  }, 1000);
}

// ===== Join Chat =====
function joinChat(teamCode) {
  const team = TEAMS[teamCode];
  currentUser = { code: teamCode, name: team.person, teamName: team.name, emoji: team.emoji, nick: `${team.person}(${team.name})` };
  document.getElementById('teamSelect').style.display = 'none';
  document.getElementById('chatScreen').style.display = 'flex';

  submittedTeams = lsGetSubmitted();
  updateStatusBar();

  if (USE_FIREBASE && initFirebase()) {
    // Load existing + listen
    messagesRef.on('child_added', snap => {
      const msg = snap.val();
      renderMessage(msg);
      if (msg.isSubmission && msg.teamCode) {
        submittedTeams.add(msg.teamCode);
        lsSaveSubmitted(submittedTeams);
        updateStatusBar();
      }
    });
    // Load submitted state
    db.ref('chatroom/submitted').on('value', snap => {
      const val = snap.val();
      if (val) { submittedTeams = new Set(Object.keys(val)); updateStatusBar(); }
    });
  } else {
    // Local mode: render existing
    const msgs = lsGetMessages();
    msgs.forEach(m => renderMessage(m));
    lastMsgCount = msgs.length;
    startLocalPoll();
  }

  // System + bot welcome
  addSystemMessage(`${currentUser.nick}ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);
  setTimeout(() => {
    addBotMessage(`ì•ˆë…•í•˜ì„¸ìš” ${currentUser.name}ë‹˜! ì‚¬ì—…ë³´ê³  ìë£Œë¥¼ ë³´ë‚´ì£¼ì„¸ìš”. ğŸ“‹\n\ní…ìŠ¤íŠ¸ë‚˜ íŒŒì¼ì„ ë³´ë‚´ì‹œë©´ ì ‘ìˆ˜ë©ë‹ˆë‹¤.\n"/í˜„í™©" ì„ ì…ë ¥í•˜ë©´ ì œì¶œ í˜„í™©ì„ ë³¼ ìˆ˜ ìˆì–´ìš”.`);
  }, 500);

  updateHeaderSub();
  document.getElementById('msgInput').focus();
}

function leaveChat() {
  if (pollTimer) clearInterval(pollTimer);
  if (messagesRef) messagesRef.off();
  document.getElementById('chatScreen').style.display = 'none';
  document.getElementById('teamSelect').style.display = 'flex';
  document.getElementById('messages').innerHTML = '';
  currentUser = null;
  lastMsgCount = 0;
}

// ===== Render =====
function renderMessage(msg) {
  const container = document.getElementById('messages');
  if (msg.type === 'system') {
    const div = document.createElement('div');
    div.className = 'msg-system';
    div.textContent = msg.text;
    container.appendChild(div);
  } else {
    const isMine = msg.sender === currentUser?.nick;
    const isBot = msg.sender === 'ì‹­í˜•í˜¸ ğŸ§ ';
    const group = document.createElement('div');
    group.className = 'msg-group';

    if (!isMine) {
      const senderEl = document.createElement('div');
      senderEl.className = 'msg-sender';
      senderEl.textContent = msg.sender;
      group.appendChild(senderEl);
    }

    const row = document.createElement('div');
    row.className = 'msg-row' + (isMine ? ' mine' : '') + (isBot ? ' bot' : '');

    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble';
    bubble.innerHTML = formatText(msg.text || '');

    if (msg.fileName) {
      const fileDiv = document.createElement('div');
      fileDiv.className = 'msg-file';
      if (msg.fileData) {
        const a = document.createElement('a');
        a.href = msg.fileData;
        a.download = msg.fileName;
        a.textContent = 'ğŸ“„ ' + msg.fileName;
        fileDiv.appendChild(a);
      } else {
        fileDiv.textContent = 'ğŸ“„ ' + msg.fileName;
      }
      bubble.appendChild(fileDiv);
    }

    const time = document.createElement('span');
    time.className = 'msg-time';
    time.textContent = formatTime(msg.ts);

    row.appendChild(bubble);
    row.appendChild(time);
    group.appendChild(row);
    container.appendChild(group);
  }
  container.scrollTop = container.scrollHeight;
}

function formatText(text) {
  // Simple: escape HTML, convert newlines, render status table
  text = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  if (text.includes('â”€â”€â”€â”€â”€â”€')) {
    // Status table rendering
    return text.replace(/\n/g, '<br>');
  }
  return text.replace(/\n/g, '<br>');
}

function formatTime(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  const h = d.getHours(); const m = d.getMinutes();
  const ampm = h < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„';
  return `${ampm} ${h % 12 || 12}:${m.toString().padStart(2, '0')}`;
}

// ===== Send Message =====
function sendMessage() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text && !pendingFile) return;

  const msg = {
    sender: currentUser.nick,
    teamCode: currentUser.code,
    text: text,
    ts: Date.now(),
    type: 'user'
  };

  const isSubmission = text.length > 0 || pendingFile;

  if (pendingFile) {
    msg.fileName = pendingFile.name;
    msg.fileData = pendingFile.data;
    msg.isSubmission = true;
    removeFile();
  }

  // Check commands
  if (text === '/í˜„í™©') {
    // Don't save as submission
    pushMessage(msg);
    input.value = '';
    autoResize(input);
    setTimeout(() => showStatusReport(), 300);
    return;
  }

  if (isSubmission && text !== '') {
    msg.isSubmission = true;
  }

  pushMessage(msg);
  input.value = '';
  autoResize(input);

  // Bot response for submission
  if (msg.isSubmission) {
    submittedTeams.add(currentUser.code);
    lsSaveSubmitted(submittedTeams);
    if (USE_FIREBASE && db) {
      const obj = {}; obj[currentUser.code] = true;
      db.ref('chatroom/submitted').update(obj);
    }
    updateStatusBar();
    sendToGAS(msg);

    const count = submittedTeams.size;
    setTimeout(() => {
      addBotMessage(`âœ… ${currentUser.teamName} ìë£Œ ì ‘ìˆ˜ ì™„ë£Œ! (${count}/6)`);
      if (count >= 6) {
        setTimeout(() => {
          addBotMessage(`ğŸ‰ ì „ì²´ ì ‘ìˆ˜ ì™„ë£Œ! ì·¨í•© ë³´ê³ ì„œë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤.\nëª¨ë“  íŒ€ ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤! ğŸ‘`);
          notifyComplete();
        }, 1000);
      }
    }, 500);
  }
}

function pushMessage(msg) {
  if (USE_FIREBASE && messagesRef) {
    messagesRef.push(msg);
  } else {
    lsSaveMessage(msg);
    renderMessage(msg);
    lastMsgCount = lsGetMessages().length;
  }
}

function addBotMessage(text) {
  const msg = { sender: 'ì‹­í˜•í˜¸ ğŸ§ ', text, ts: Date.now(), type: 'bot' };
  pushMessage(msg);
}

function addSystemMessage(text) {
  const msg = { type: 'system', text, ts: Date.now() };
  pushMessage(msg);
}

// ===== Status =====
function updateStatusBar() {
  const dots = document.getElementById('statusDots');
  dots.innerHTML = '';
  Object.entries(TEAMS).forEach(([code, team]) => {
    const dot = document.createElement('span');
    dot.className = 'status-dot' + (submittedTeams.has(code) ? ' done' : '');
    dot.textContent = team.emoji;
    dot.title = team.name;
    dots.appendChild(dot);
  });
  document.getElementById('statusText').textContent = `${submittedTeams.size}/6`;
}

function showStatusReport() {
  let lines = ['ğŸ“‹ ì œì¶œ í˜„í™© ë¦¬í¬íŠ¸', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'];
  Object.entries(TEAMS).forEach(([code, team]) => {
    const done = submittedTeams.has(code);
    lines.push(`${done ? 'âœ…' : 'â¬œ'} ${team.emoji} ${team.name} (${team.person}) ${done ? 'â€” ì œì¶œì™„ë£Œ' : 'â€” ë¯¸ì œì¶œ'}`);
  });
  lines.push('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
  lines.push(`ì´ ${submittedTeams.size}/6íŒ€ ì œì¶œ ì™„ë£Œ`);
  addBotMessage(lines.join('\n'));
}

function updateHeaderSub() {
  document.getElementById('headerSub').textContent = `ì°¸ì—¬ ì¤‘: ${currentUser.nick}`;
}

// ===== File Handling =====
function handleFile(input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 5 * 1024 * 1024) { alert('5MB ì´í•˜ íŒŒì¼ë§Œ ì²¨ë¶€ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
  const reader = new FileReader();
  reader.onload = (e) => {
    pendingFile = { name: file.name, data: e.target.result };
    document.getElementById('filePreview').style.display = 'flex';
    document.getElementById('fileName').textContent = file.name;
  };
  reader.readAsDataURL(file);
  input.value = '';
}

function removeFile() {
  pendingFile = null;
  document.getElementById('filePreview').style.display = 'none';
}

// ===== Input Helpers =====
function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

// ===== Google Apps Script =====
function sendToGAS(msg) {
  if (!GAS_URL) return;
  const params = new URLSearchParams({
    teamCode: msg.teamCode,
    teamName: currentUser.teamName,
    person: currentUser.name,
    text: msg.text || '',
    fileName: msg.fileName || ''
  });
  fetch(GAS_URL + '?' + params.toString(), { method: 'POST', mode: 'no-cors' }).catch(() => {});
}

function notifyComplete() {
  if (!GAS_URL) return;
  fetch(GAS_URL + '?action=notifyComplete', { method: 'POST', mode: 'no-cors' }).catch(() => {});
}
</script>

<!-- Firebase SDK (uncomment when ready) -->
<!-- <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script> -->
<!-- <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script> -->

</body>
</html>
