<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>ë‘ë ˆìƒí˜‘ íŒ€ì¥ë°©</title>
<style>
:root{--bg:#F5F0E8;--card:#FFFFFF;--primary:#2D5016;--primary-light:#4a7a2e;--accent:#8B7355;--text:#333;--text-light:#666;--bubble-me:#DCF8C6;--bubble-other:#FFF;--bubble-bot:#E8F5E1;--border:#E0D8C8;--input-bg:#FFF;--header:#2D5016}
*{margin:0;padding:0;box-sizing:border-box}
html{height:100%;height:100dvh}
body{font-family:-apple-system,'Noto Sans KR',sans-serif;background:var(--bg);height:100%;display:flex;flex-direction:column;color:var(--text);overflow:hidden}
.header{background:var(--header);color:#fff;padding:12px 16px;padding-top:max(12px,env(safe-area-inset-top));display:flex;align-items:center;justify-content:space-between;flex-shrink:0;z-index:10}
.header h1{font-size:16px;font-weight:700}.header-right{display:flex;gap:8px;align-items:center}
.online-badge{background:rgba(255,255,255,.2);padding:3px 10px;border-radius:12px;font-size:12px}
.btn-icon{background:none;border:none;color:#fff;font-size:18px;cursor:pointer;padding:4px}
.messages{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:6px;-webkit-overflow-scrolling:touch}
.msg{max-width:80%;padding:8px 12px;border-radius:12px;font-size:14px;line-height:1.5;word-break:break-word;position:relative}
.msg.me{align-self:flex-end;background:var(--bubble-me);border-bottom-right-radius:4px}
.msg.other{align-self:flex-start;background:var(--bubble-other);border-bottom-left-radius:4px;box-shadow:0 1px 2px rgba(0,0,0,.06)}
.msg.bot{align-self:flex-start;background:var(--bubble-bot);border-bottom-left-radius:4px;border-left:3px solid var(--primary)}
.msg .sender{font-size:11px;font-weight:700;color:var(--primary);margin-bottom:2px}
.msg .time{font-size:10px;color:var(--text-light);text-align:right;margin-top:2px}
.msg .file-link{display:inline-block;background:var(--primary);color:#fff;padding:3px 10px;border-radius:8px;font-size:12px;text-decoration:none;margin-top:4px}
.system-msg{text-align:center;font-size:12px;color:var(--accent);padding:4px 0}
.input-area{background:var(--card);border-top:1px solid var(--border);padding:8px 12px;padding-bottom:max(8px,env(safe-area-inset-bottom));display:flex;gap:8px;align-items:center;flex-shrink:0}
.input-area input[type=text]{flex:1;border:1px solid var(--border);border-radius:20px;padding:8px 14px;font-size:14px;outline:none;background:var(--bg)}
.input-area input[type=text]:focus{border-color:var(--primary)}
.send-btn{background:var(--primary);color:#fff;border:none;border-radius:50%;width:36px;height:36px;font-size:18px;cursor:pointer;flex-shrink:0}
.upload-btn{background:none;border:none;font-size:22px;cursor:pointer;color:var(--accent);flex-shrink:0}
/* Login */
.login-overlay{position:fixed;inset:0;background:var(--bg);z-index:100;display:flex;align-items:center;justify-content:center}
.login-box{background:var(--card);padding:32px 24px;border-radius:16px;width:min(320px,90vw);box-shadow:0 4px 20px rgba(0,0,0,.1);text-align:center}
.login-box h2{color:var(--primary);margin-bottom:4px;font-size:20px}.login-box p{color:var(--accent);font-size:13px;margin-bottom:20px}
.login-box select,.login-box input{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;font-size:14px;margin-bottom:12px;background:#fff}
.login-box button{width:100%;padding:10px;background:var(--primary);color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer}
/* Settings modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:200;display:none;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:#fff;border-radius:16px;padding:24px;width:min(320px,90vw)}
.modal h3{margin-bottom:16px;color:var(--primary)}.modal label{display:block;font-size:13px;color:var(--text-light);margin-bottom:4px}
.modal input,.modal select{width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;margin-bottom:12px;font-size:14px}
.modal button{padding:8px 16px;border:none;border-radius:8px;cursor:pointer;font-size:14px}
.modal .btn-primary{background:var(--primary);color:#fff}.modal .btn-cancel{background:#eee;color:#333;margin-left:8px}
pre{white-space:pre-wrap;font-family:inherit}
/* Schedule Panel */
.sched-overlay{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:300;display:none;opacity:0;transition:opacity .3s}
.sched-overlay.show{display:block;opacity:1}
.sched-panel{position:fixed;top:0;right:-100%;width:min(360px,88vw);height:100%;background:var(--bg);z-index:310;transition:right .3s ease;display:flex;flex-direction:column;box-shadow:-4px 0 20px rgba(0,0,0,.15)}
.sched-panel.show{right:0}
.sched-event{background:#fff;border-radius:12px;padding:12px 14px;margin-bottom:8px;box-shadow:0 1px 4px rgba(45,80,22,.1);position:relative}
.sched-event .sched-emoji{font-size:20px;margin-right:6px}
.sched-event .sched-title{font-weight:700;font-size:14px;color:var(--text)}
.sched-event .sched-date{font-size:12px;color:var(--primary);font-weight:600;margin-top:2px}
.sched-event .sched-desc{font-size:12px;color:var(--text-light);margin-top:2px}
.sched-event .sched-dday{position:absolute;top:12px;right:14px;font-size:12px;font-weight:700;padding:2px 8px;border-radius:10px}
.sched-dday.past{background:#eee;color:#999}
.sched-dday.today{background:#FF6B35;color:#fff}
.sched-dday.soon{background:#FFF3CD;color:#856404}
.sched-dday.future{background:#E8F5E1;color:#2D5016}
.sched-del{position:absolute;bottom:8px;right:10px;background:none;border:none;color:#ccc;font-size:14px;cursor:pointer}
.sched-del:hover{color:#c00}
/* Notes Panel */
.notes-overlay{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:300;display:none;opacity:0;transition:opacity .3s}
.notes-overlay.show{display:block;opacity:1}
.notes-panel{position:fixed;top:0;right:-100%;width:min(360px,88vw);height:100%;background:var(--bg);z-index:310;transition:right .3s ease;display:flex;flex-direction:column;box-shadow:-4px 0 20px rgba(0,0,0,.15)}
.notes-panel.show{right:0}
.notes-header{background:var(--header);color:#fff;padding:14px 16px;padding-top:max(14px,env(safe-area-inset-top));display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.notes-header h2{font-size:16px;font-weight:700}
.notes-body{flex:1;overflow-y:auto;padding:12px;-webkit-overflow-scrolling:touch}
.note-card{background:#fff;border-radius:12px;padding:12px 14px;margin-bottom:8px;box-shadow:0 1px 4px rgba(45,80,22,.1);cursor:pointer;transition:transform .15s}
.note-card:active{transform:scale(.97)}
.note-card .note-title{font-weight:600;font-size:14px;color:var(--text)}.note-card .note-meta{font-size:11px;color:var(--text-light);margin-top:4px}
.note-status{display:inline-block;font-size:11px;padding:1px 6px;border-radius:8px;margin-left:6px}
.note-status.editing{background:#FFF3CD;color:#856404}.note-status.confirmed{background:#E8F5E1;color:#2D5016}
.note-add-btn{width:100%;padding:12px;border:2px dashed var(--border);border-radius:12px;background:none;font-size:14px;color:var(--accent);cursor:pointer;margin-bottom:8px}
.note-detail{display:none;flex-direction:column;height:100%}
.note-detail.show{display:flex}
.note-list-view{display:flex;flex-direction:column;height:100%}
.note-list-view.hide{display:none}
.note-items{flex:1;overflow-y:auto;padding:12px}
.note-item{display:flex;align-items:center;gap:8px;padding:8px 4px;border-bottom:1px solid var(--border)}
.note-item input[type=checkbox]{width:18px;height:18px;accent-color:var(--primary);flex-shrink:0}
.note-item .item-text{flex:1;font-size:14px}.note-item .item-text.checked{text-decoration:line-through;color:var(--text-light)}
.note-item .item-author{font-size:10px;color:var(--accent);flex-shrink:0}
.note-item .item-del{background:none;border:none;color:#ccc;font-size:16px;cursor:pointer;padding:2px 4px;flex-shrink:0}
.note-item .item-del:hover{color:#c00}
.note-add-item{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border);flex-shrink:0}
.note-add-item input{flex:1;border:1px solid var(--border);border-radius:20px;padding:8px 14px;font-size:14px;outline:none;background:#fff}
.note-add-item button{background:var(--primary);color:#fff;border:none;border-radius:50%;width:34px;height:34px;font-size:16px;cursor:pointer;flex-shrink:0}
.note-actions{display:flex;gap:8px;padding:8px 12px;border-top:1px solid var(--border);flex-shrink:0;flex-wrap:wrap}
.note-actions button{flex:1;padding:8px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer}
.note-btn-confirm{background:#E8F5E1;color:#2D5016}.note-btn-edit{background:#FFF3CD;color:#856404}.note-btn-delete{background:#FFDDDD;color:#c00}
</style>
</head>
<body>

<!-- ===== LOGIN ===== -->
<div class="login-overlay" id="loginOverlay">
<div class="login-box">
  <h2>ğŸŒ¿ ë‘ë ˆìƒí˜‘</h2>
  <p>íŒ€ì¥ë°© - ì‚¬ì—…ë³´ê³ </p>
  <select id="loginTeam">
    <option value="">íŒ€ ì„ íƒ</option>
    <option value="livestock|ì¶•ìˆ˜ì‚°íŒ€|ìƒì˜">ì¶•ìˆ˜ì‚°íŒ€ - ìƒì˜</option>
    <option value="agri|ë†ì‚°íŒ€|ì •í˜„">ë†ì‚°íŒ€ - ì •í˜„</option>
    <option value="processed|ê°€ê³µíŒ€|ê¸°í˜„">ê°€ê³µíŒ€ - ê¸°í˜„</option>
    <option value="store|ë§¤ì¥ì‚¬ì—…íŒ€|ì¸ì„œìš¸">ë§¤ì¥ì‚¬ì—…íŒ€ - ì¸ì„œìš¸</option>
    <option value="online|ì˜¨ë¼ì¸íŒ€|ì´ì§€ì›">ì˜¨ë¼ì¸íŒ€ - ì´ì§€ì›</option>
    <option value="exec|ì‚¬ì—…ìƒë¬´|100ìƒë¬´ë‹˜">ì‚¬ì—…ìƒë¬´ - 100ìƒë¬´ë‹˜</option>
  </select>
  <input id="loginName" placeholder="ë‹‰ë„¤ì„ (ìë™ì…ë ¥)" readonly>
  <button onclick="doLogin()">ì…ì¥í•˜ê¸°</button>
</div>
</div>

<!-- ===== CHAT ===== -->
<div class="header">
  <h1>ğŸŒ¿ íŒ€ì¥ë°©</h1>
  <div class="header-right">
    <span class="online-badge" id="onlineBadge">ì ‘ì† 1ëª…</span>
    <button class="btn-icon" onclick="openSchedule()">ğŸ“…</button>
    <button class="btn-icon" onclick="openNotes()">ğŸ“</button>
    <button class="btn-icon" onclick="openSettings()">âš™ï¸</button>
  </div>
</div>
<div class="messages" id="messages"></div>
<div class="input-area">
  <label class="upload-btn">ğŸ“<input type="file" hidden id="fileInput" onchange="uploadFile()"></label>
  <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ ë˜ëŠ” /í˜„í™© /ì·¨í•© /ë¦¬ë§ˆì¸ë“œ" onkeydown="if(event.key==='Enter')sendMsg()">
  <button class="send-btn" onclick="sendMsg()">â†‘</button>
</div>

<!-- ===== SETTINGS ===== -->
<div class="modal-overlay" id="settingsModal">
<div class="modal">
  <h3>âš™ï¸ ì„¤ì •</h3>
  <label>API ì„œë²„ URL</label>
  <input id="settingsUrl" placeholder="https://...">
  <hr style="border:none;border-top:1px solid var(--border);margin:16px 0 12px">
  <button style="width:100%;padding:10px;background:#c00;color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer" onclick="resetChat()">ğŸ—‘ï¸ ì±„íŒ… ë¦¬ì…‹</button>
  <div style="text-align:right;margin-top:12px">
    <button class="btn-primary" onclick="saveSettings()">ì €ì¥</button>
    <button class="btn-cancel" onclick="closeSettings()">ì·¨ì†Œ</button>
  </div>
</div>
</div>

<!-- NOTES PANEL -->
<div class="notes-overlay" id="notesOverlay" onclick="closeNotes()"></div>
<div class="notes-panel" id="notesPanel">
  <div class="note-list-view" id="noteListView">
    <div class="notes-header">
      <h2>ğŸ“ ê³µìœ  ë©”ëª¨</h2>
      <button class="btn-icon" onclick="closeNotes()" style="color:#fff;font-size:20px">âœ•</button>
    </div>
    <div class="notes-body" id="noteListBody">
      <button class="note-add-btn" onclick="createNote()">â• ìƒˆ ë©”ëª¨ ë§Œë“¤ê¸°</button>
      <div id="noteList"></div>
    </div>
  </div>
  <div class="note-detail" id="noteDetailView">
    <div class="notes-header">
      <div style="display:flex;align-items:center;gap:8px">
        <button class="btn-icon" onclick="backToList()" style="color:#fff;font-size:18px">â†</button>
        <h2 id="noteDetailTitle">ë©”ëª¨</h2>
      </div>
      <span class="note-status" id="noteDetailStatus"></span>
    </div>
    <div class="note-items" id="noteItems"></div>
    <div class="note-add-item">
      <input id="noteItemInput" placeholder="í•­ëª© ì¶”ê°€..." onkeydown="if(event.key==='Enter')addNoteItem()">
      <button onclick="addNoteItem()">+</button>
    </div>
    <div class="note-actions">
      <button class="note-btn-confirm" id="noteConfirmBtn" onclick="toggleNoteStatus()">âœ… í™•ì •</button>
      <button class="note-btn-delete" onclick="deleteCurrentNote()">ğŸ—‘ï¸ ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- SCHEDULE PANEL -->
<div class="sched-overlay" id="schedOverlay" onclick="closeSchedule()"></div>
<div class="sched-panel" id="schedPanel">
  <div class="notes-header">
    <h2>ğŸ“… ì¼ì •í‘œ</h2>
    <button class="btn-icon" onclick="closeSchedule()" style="color:#fff;font-size:20px">âœ•</button>
  </div>
  <div class="notes-body" id="schedBody">
    <button class="note-add-btn" onclick="addScheduleEvent()">â• ì¼ì • ì¶”ê°€</button>
    <div id="schedList"></div>
  </div>
</div>

<input type="file" hidden id="hiddenFile">

<script>
const ROOM = 'report';
let API_URL = localStorage.getItem('report_api_url') || 'https://basically-yearly-foo-statewide.trycloudflare.com';
let user = JSON.parse(localStorage.getItem('report_user') || 'null');
let lastTs = 0;
let pollTimer = null;
const msgEl = document.getElementById('messages');
const onlineSessions = new Set();

// Login
document.getElementById('loginTeam').onchange = function() {
  const parts = this.value.split('|');
  document.getElementById('loginName').value = parts[2] || '';
};

function doLogin() {
  const val = document.getElementById('loginTeam').value;
  if (!val) return alert('íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
  const [teamId, team, name] = val.split('|');
  user = { sender: name, team, teamId };
  localStorage.setItem('report_user', JSON.stringify(user));
  document.getElementById('loginOverlay').style.display = 'none';
  addSystem(`${name}ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤`);
  startPolling();
}

if (user) {
  document.getElementById('loginOverlay').style.display = 'none';
  startPolling();
}

// Settings
function openSettings() {
  document.getElementById('settingsUrl').value = API_URL;
  document.getElementById('settingsModal').classList.add('show');
}
function closeSettings() { document.getElementById('settingsModal').classList.remove('show'); }
function saveSettings() {
  const v = document.getElementById('settingsUrl').value.replace(/\/$/,'');
  if (v) { API_URL = v; localStorage.setItem('report_api_url', v); }
  closeSettings();
}

// Messages
function addBubble(msg) {
  const isMe = msg.type === 'user' && msg.sender === user?.sender;
  const div = document.createElement('div');
  div.className = `msg ${msg.type === 'bot' ? 'bot' : isMe ? 'me' : 'other'}`;
  const t = new Date(msg.timestamp).toLocaleTimeString('ko',{hour:'2-digit',minute:'2-digit'});
  let html = '';
  if (!isMe && msg.type !== 'bot') html += `<div class="sender">${esc(msg.sender)}${msg.team ? ' Â· ' + msg.team : ''}</div>`;
  if (msg.type === 'bot') html += `<div class="sender">í´ë¡œì´ ğŸ¤–</div>`;
  html += `<pre>${esc(msg.text)}</pre>`;
  if (msg.fileName && msg.filePath) html += `<a class="file-link" href="${API_URL}/api/download/${encodeURIComponent(msg.filePath)}" target="_blank">ğŸ“¥ ${esc(msg.fileName)}</a>`;
  else if (msg.fileName) html += `<span style="font-size:12px;color:var(--accent)">ğŸ“ ${esc(msg.fileName)}</span>`;
  html += `<div class="time">${t}</div>`;
  div.innerHTML = html;
  msgEl.appendChild(div);
}

function addSystem(text) {
  const div = document.createElement('div');
  div.className = 'system-msg';
  div.textContent = text;
  msgEl.appendChild(div);
  scrollBottom();
}

function scrollBottom() { requestAnimationFrame(() => msgEl.scrollTop = msgEl.scrollHeight); }
function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// API
async function sendMsg() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  try {
    const res = await fetch(`${API_URL}/api/message`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ text, sender: user.sender, team: user.team, teamId: user.teamId, room: ROOM })
    });
    const data = await res.json();
    // Bot response will appear via polling
    fetchMessages();
  } catch (e) { addSystem('âš ï¸ ì „ì†¡ ì‹¤íŒ¨: ' + e.message); }
}

async function uploadFile() {
  const file = document.getElementById('fileInput').files[0];
  if (!file) return;
  const fd = new FormData();
  fd.append('file', file);
  fd.append('sender', user.sender);
  fd.append('team', user.team);
  fd.append('teamId', user.teamId);
  fd.append('room', ROOM);
  try {
    addSystem('ğŸ“¤ ì—…ë¡œë“œ ì¤‘...');
    const res = await fetch(`${API_URL}/api/upload`, { method: 'POST', body: fd });
    await res.json();
    fetchMessages();
  } catch (e) { addSystem('âš ï¸ ì—…ë¡œë“œ ì‹¤íŒ¨'); }
  document.getElementById('fileInput').value = '';
}

async function fetchMessages() {
  try {
    const res = await fetch(`${API_URL}/api/messages?room=${ROOM}&since=${lastTs}`);
    const data = await res.json();
    if (data.messages?.length) {
      data.messages.forEach(m => { addBubble(m); if (m.timestamp > lastTs) lastTs = m.timestamp; });
      scrollBottom();
    }
  } catch {}
}

function startPolling() {
  fetchMessages();
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(fetchMessages, 3000);
}

// Online count
function updateOnline() {
  onlineSessions.add(user?.sender || 'anon');
  document.getElementById('onlineBadge').textContent = `ì ‘ì† ${onlineSessions.size}ëª…`;
}
if (user) updateOnline();

// Reset
async function resetChat() {
  if (!confirm('ì±„íŒ… ë‚´ìš©ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”? (ì œì¶œ í˜„í™©ë„ ì´ˆê¸°í™”ë©ë‹ˆë‹¤)')) return;
  try {
    await fetch(`${API_URL}/api/reset?room=${ROOM}`, { method: 'POST' });
    msgEl.innerHTML = '';
    lastTs = 0;
    addSystem('ğŸ—‘ï¸ ì±„íŒ…ì´ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤');
    closeSettings();
  } catch { alert('ë¦¬ì…‹ ì‹¤íŒ¨'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Notes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentNoteId = null;
let notesPollTimer = null;

function openNotes() {
  document.getElementById('notesOverlay').classList.add('show');
  document.getElementById('notesPanel').classList.add('show');
  backToList();
}
function closeNotes() {
  document.getElementById('notesOverlay').classList.remove('show');
  document.getElementById('notesPanel').classList.remove('show');
  if (notesPollTimer) { clearInterval(notesPollTimer); notesPollTimer = null; }
}
function backToList() {
  document.getElementById('noteListView').classList.remove('hide');
  document.getElementById('noteDetailView').classList.remove('show');
  currentNoteId = null;
  if (notesPollTimer) { clearInterval(notesPollTimer); notesPollTimer = null; }
  fetchNoteList();
}

async function fetchNoteList() {
  try {
    const res = await fetch(`${API_URL}/api/notes?room=${ROOM}`);
    const data = await res.json();
    const el = document.getElementById('noteList');
    if (!data.notes?.length) { el.innerHTML = '<p style="text-align:center;color:var(--text-light);padding:20px;font-size:13px">ì•„ì§ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤ ğŸ“‹</p>'; return; }
    el.innerHTML = data.notes.map(n => `<div class="note-card" onclick="openNoteDetail('${n.id}')">
      <span class="note-title">${esc(n.title)}</span>
      <span class="note-status ${n.status}">${n.status==='confirmed'?'âœ… í™•ì •':'âœï¸ ìˆ˜ì •ì¤‘'}</span>
      <div class="note-meta">${esc(n.creator)} Â· í•­ëª© ${n.itemCount}ê°œ</div>
    </div>`).join('');
  } catch {}
}

async function createNote() {
  const title = prompt('ë©”ëª¨ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
  if (!title?.trim()) return;
  try {
    await fetch(`${API_URL}/api/notes`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ room: ROOM, title: title.trim(), creator: user.sender }) });
    fetchNoteList();
  } catch { alert('ìƒì„± ì‹¤íŒ¨'); }
}

async function openNoteDetail(id) {
  currentNoteId = id;
  document.getElementById('noteListView').classList.add('hide');
  document.getElementById('noteDetailView').classList.add('show');
  fetchNoteDetail();
  if (notesPollTimer) clearInterval(notesPollTimer);
  notesPollTimer = setInterval(fetchNoteDetail, 3000);
}

async function fetchNoteDetail() {
  if (!currentNoteId) return;
  try {
    const res = await fetch(`${API_URL}/api/notes/${currentNoteId}?room=${ROOM}`);
    const { note } = await res.json();
    document.getElementById('noteDetailTitle').textContent = note.title;
    const statusEl = document.getElementById('noteDetailStatus');
    statusEl.textContent = note.status === 'confirmed' ? 'âœ… í™•ì •' : 'âœï¸ ìˆ˜ì •ì¤‘';
    statusEl.className = `note-status ${note.status}`;
    const btn = document.getElementById('noteConfirmBtn');
    btn.textContent = note.status === 'confirmed' ? 'âœï¸ ìˆ˜ì •ëª¨ë“œ' : 'âœ… í™•ì •';
    btn.className = note.status === 'confirmed' ? 'note-btn-edit' : 'note-btn-confirm';
    const itemsEl = document.getElementById('noteItems');
    itemsEl.innerHTML = (note.items||[]).map((it,i) => `<div class="note-item">
      <input type="checkbox" ${it.checked?'checked':''} onchange="toggleItem(${i},this.checked)">
      <span class="item-text ${it.checked?'checked':''}">${esc(it.text)}</span>
      <span class="item-author">${esc(it.author)}</span>
      <button class="item-del" onclick="deleteItem(${i})">âœ•</button>
    </div>`).join('') || '<p style="text-align:center;color:var(--text-light);padding:20px;font-size:13px">í•­ëª©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>';
  } catch {}
}

async function updateNote(updates) {
  try {
    await fetch(`${API_URL}/api/notes/${currentNoteId}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ room: ROOM, ...updates }) });
    fetchNoteDetail();
  } catch {}
}

async function addNoteItem() {
  const input = document.getElementById('noteItemInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  try {
    const res = await fetch(`${API_URL}/api/notes/${currentNoteId}?room=${ROOM}`);
    const { note } = await res.json();
    const items = [...(note.items||[]), { text, checked: false, author: user.sender }];
    updateNote({ items });
  } catch {}
}

async function toggleItem(idx, checked) {
  try {
    const res = await fetch(`${API_URL}/api/notes/${currentNoteId}?room=${ROOM}`);
    const { note } = await res.json();
    if (note.items[idx]) note.items[idx].checked = checked;
    updateNote({ items: note.items });
  } catch {}
}

async function deleteItem(idx) {
  try {
    const res = await fetch(`${API_URL}/api/notes/${currentNoteId}?room=${ROOM}`);
    const { note } = await res.json();
    note.items.splice(idx, 1);
    updateNote({ items: note.items });
  } catch {}
}

async function toggleNoteStatus() {
  try {
    const res = await fetch(`${API_URL}/api/notes/${currentNoteId}?room=${ROOM}`);
    const { note } = await res.json();
    const newStatus = note.status === 'confirmed' ? 'editing' : 'confirmed';
    updateNote({ status: newStatus, confirmedBy: newStatus === 'confirmed' ? user.sender : null });
  } catch {}
}

async function deleteCurrentNote() {
  if (!confirm('ì´ ë©”ëª¨ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
  try {
    await fetch(`${API_URL}/api/notes/${currentNoteId}?room=${ROOM}`, { method:'DELETE' });
    backToList();
  } catch { alert('ì‚­ì œ ì‹¤íŒ¨'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Schedule
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSchedule() {
  document.getElementById('schedOverlay').classList.add('show');
  document.getElementById('schedPanel').classList.add('show');
  fetchSchedule();
}
function closeSchedule() {
  document.getElementById('schedOverlay').classList.remove('show');
  document.getElementById('schedPanel').classList.remove('show');
}

async function fetchSchedule() {
  try {
    const res = await fetch(`${API_URL}/api/schedule?room=${ROOM}`);
    const data = await res.json();
    const el = document.getElementById('schedList');
    if (!data.events?.length) { el.innerHTML = '<p style="text-align:center;color:var(--text-light);padding:20px;font-size:13px">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤ ğŸ“…</p>'; return; }
    const now = new Date(); now.setHours(0,0,0,0);
    el.innerHTML = data.events.map(ev => {
      const d = new Date(ev.date); d.setHours(0,0,0,0);
      const diff = Math.floor((d - now) / 86400000);
      let ddayText, ddayClass;
      if (diff < 0) { ddayText = `D+${Math.abs(diff)}`; ddayClass = 'past'; }
      else if (diff === 0) { ddayText = 'D-DAY'; ddayClass = 'today'; }
      else if (diff <= 3) { ddayText = `D-${diff}`; ddayClass = 'soon'; }
      else { ddayText = `D-${diff}`; ddayClass = 'future'; }
      const dateStr = ev.date.replace(/^\d{4}-/, '').replace('-', '/') + (ev.time ? ' ' + ev.time : '');
      return `<div class="sched-event">
        <span class="sched-dday ${ddayClass}">${ddayText}</span>
        <div><span class="sched-emoji">${esc(ev.emoji)}</span><span class="sched-title">${esc(ev.title)}</span></div>
        <div class="sched-date">${dateStr}</div>
        ${ev.description ? `<div class="sched-desc">${esc(ev.description)}</div>` : ''}
        <button class="sched-del" onclick="deleteScheduleEvent('${ev.id}')">ğŸ—‘ï¸</button>
      </div>`;
    }).join('');
  } catch { document.getElementById('schedList').innerHTML = '<p style="text-align:center;color:#c00;padding:20px;font-size:13px">âš ï¸ ì„œë²„ ì—°ê²° ì‹¤íŒ¨</p>'; }
}

async function addScheduleEvent() {
  const title = prompt('ì¼ì • ì œëª©');
  if (!title?.trim()) return;
  const date = prompt('ë‚ ì§œ (YYYY-MM-DD)', new Date().toISOString().slice(0, 10));
  if (!date?.trim()) return;
  const time = prompt('ì‹œê°„ (HH:MM, ì—†ìœ¼ë©´ ë¹ˆì¹¸)', '') || '';
  try {
    await fetch(`${API_URL}/api/schedule`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ room: ROOM, title: title.trim(), date: date.trim(), time: time.trim(), emoji: 'ğŸ“Œ', createdBy: user?.sender || '' })
    });
    fetchSchedule();
  } catch { alert('ì¼ì • ì¶”ê°€ ì‹¤íŒ¨'); }
}

async function deleteScheduleEvent(id) {
  if (!confirm('ì´ ì¼ì •ì„ ì‚­ì œí• ê¹Œìš”?')) return;
  try {
    await fetch(`${API_URL}/api/schedule/${id}?room=${ROOM}`, { method: 'DELETE' });
    fetchSchedule();
  } catch { alert('ì‚­ì œ ì‹¤íŒ¨'); }
}
</script>
</body>
</html>
