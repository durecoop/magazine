<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë‘ë ˆìƒí˜‘ ì‚¬ì—…ë³´ê³  ì±„íŒ…ë°©</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒ¿</text></svg>">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--green:#2D5016;--beige:#F5F0E8;--brown:#8B7355;--light-green:#E8F5E1;--my-bubble:#D4EDC9;--bot-bubble:#F0F8E8;--other-bubble:#fff}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans KR',sans-serif;background:var(--beige);height:100vh;height:100dvh;display:flex;flex-direction:column;overflow:hidden}
/* Login Screen */
#loginScreen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:20px;background:linear-gradient(135deg,#2D5016 0%,#4a7a2e 100%)}
#loginScreen h1{color:#fff;font-size:1.6em;margin-bottom:6px;text-shadow:0 2px 4px rgba(0,0,0,.2)}
#loginScreen p{color:rgba(255,255,255,.85);font-size:.9em;margin-bottom:30px}
.team-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;max-width:400px}
.team-card{background:rgba(255,255,255,.95);border-radius:16px;padding:18px 14px;text-align:center;cursor:pointer;transition:all .2s;border:3px solid transparent;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.team-card:hover,.team-card:active{transform:scale(1.03);border-color:var(--green);box-shadow:0 4px 16px rgba(45,80,22,.3)}
.team-card .emoji{font-size:2em;margin-bottom:6px}
.team-card .team-name{font-weight:700;color:var(--green);font-size:1em}
.team-card .person{color:var(--brown);font-size:.85em;margin-top:2px}
/* Chat Screen */
#chatScreen{display:none;flex-direction:column;height:100%}
/* Header */
.chat-header{background:var(--green);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.chat-header .title{font-size:1.05em;font-weight:700}
.chat-header .subtitle{font-size:.75em;opacity:.8;margin-top:2px}
.header-left{display:flex;align-items:center;gap:10px}
.back-btn{background:none;border:none;color:#fff;font-size:1.3em;cursor:pointer;padding:4px}
/* Progress Bar */
.progress-bar{background:rgba(255,255,255,.12);padding:8px 16px;display:flex;gap:6px;flex-wrap:wrap;flex-shrink:0;border-bottom:1px solid rgba(255,255,255,.1)}
.progress-item{font-size:.78em;background:rgba(255,255,255,.15);padding:3px 8px;border-radius:10px;white-space:nowrap}
.progress-item.done{background:rgba(212,237,201,.3);color:#D4EDC9}
.progress-item.pending{opacity:.6}
/* Messages */
.messages{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:8px;-webkit-overflow-scrolling:touch;scroll-behavior:smooth}
.msg-row{display:flex;align-items:flex-end;gap:6px;max-width:85%}
.msg-row.mine{align-self:flex-end;flex-direction:row-reverse}
.msg-row.other{align-self:flex-start}
.msg-row.bot{align-self:flex-start}
.avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.85em;flex-shrink:0;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.msg-row.mine .avatar{display:none}
.bubble{padding:10px 14px;border-radius:16px;font-size:.92em;line-height:1.5;word-break:break-word;position:relative;box-shadow:0 1px 2px rgba(0,0,0,.06)}
.msg-row.mine .bubble{background:var(--my-bubble);border-bottom-right-radius:4px;color:#1a3a0a}
.msg-row.other .bubble{background:var(--other-bubble);border-bottom-left-radius:4px;color:#333}
.msg-row.bot .bubble{background:var(--bot-bubble);border-bottom-left-radius:4px;color:#2D5016;border:1px solid #c5e1b5}
.sender-name{font-size:.75em;font-weight:700;color:var(--brown);margin-bottom:3px}
.msg-time{font-size:.65em;color:#999;margin-top:3px;text-align:right}
.file-card{background:rgba(45,80,22,.08);border:1px solid rgba(45,80,22,.2);border-radius:10px;padding:10px 12px;margin-top:6px;display:flex;align-items:center;gap:8px}
.file-card .file-icon{font-size:1.5em}
.file-card .file-info{flex:1;min-width:0}
.file-card .file-name{font-size:.82em;font-weight:600;color:var(--green);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.file-card .file-size{font-size:.7em;color:#999}
.file-card .dl-btn{background:var(--green);color:#fff;border:none;padding:6px 12px;border-radius:8px;font-size:.78em;cursor:pointer;white-space:nowrap}
.dl-btn:active{opacity:.7}
.status-table{width:100%;border-collapse:collapse;margin-top:8px;font-size:.82em}
.status-table td,.status-table th{padding:5px 8px;border-bottom:1px solid rgba(45,80,22,.15);text-align:left}
.status-table th{color:var(--green);font-weight:600}
.report-btn{display:inline-block;background:var(--green);color:#fff;border:none;padding:10px 20px;border-radius:12px;font-size:.88em;cursor:pointer;margin-top:8px;text-decoration:none;font-weight:600}
.report-btn:active{opacity:.7}
/* Input Area */
.input-area{background:#fff;padding:8px 12px;display:flex;align-items:flex-end;gap:8px;flex-shrink:0;border-top:1px solid #e0d8cc;padding-bottom:max(8px,env(safe-area-inset-bottom))}
.input-area textarea{flex:1;border:1px solid #ddd;border-radius:20px;padding:10px 14px;font-size:.92em;resize:none;max-height:100px;min-height:40px;line-height:1.4;font-family:inherit;outline:none}
.input-area textarea:focus{border-color:var(--green)}
.input-area button{width:40px;height:40px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.2em;flex-shrink:0;transition:background .2s}
.attach-btn{background:var(--beige);color:var(--brown)}
.send-btn{background:var(--green);color:#fff}
.send-btn:active,.attach-btn:active{opacity:.7}
#fileInput{display:none}
/* Demo badge */
.demo-badge{position:fixed;top:60px;right:10px;background:#ff9800;color:#fff;padding:3px 10px;border-radius:10px;font-size:.7em;font-weight:700;z-index:100;opacity:.8}
/* System message */
.system-msg{text-align:center;font-size:.78em;color:#999;padding:4px 0}
@media(min-width:600px){.team-grid{grid-template-columns:1fr 1fr 1fr}.messages{max-width:700px;margin:0 auto;width:100%}.input-area{max-width:700px;margin:0 auto;width:100%}}
</style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen">
  <h1>ğŸŒ¿ ë‘ë ˆìƒí˜‘ ì‚¬ì—…ë³´ê³ </h1>
  <p>íŒ€ì„ ì„ íƒí•´ ì±„íŒ…ë°©ì— ì…ì¥í•˜ì„¸ìš”</p>
  <div class="team-grid" id="teamGrid"></div>
</div>

<!-- Chat Screen -->
<div id="chatScreen">
  <div class="chat-header">
    <div class="header-left">
      <button class="back-btn" onclick="logout()">â†</button>
      <div>
        <div class="title">ğŸŒ¿ ì‚¬ì—…ë³´ê³  ì±„íŒ…ë°©</div>
        <div class="subtitle" id="onlineStatus">ì ‘ì† ì¤‘</div>
      </div>
    </div>
  </div>
  <div class="progress-bar" id="progressBar"></div>
  <div class="messages" id="messages"></div>
  <div class="input-area">
    <button class="attach-btn" onclick="document.getElementById('fileInput').click()">ğŸ“</button>
    <input type="file" id="fileInput" accept=".xlsx,.xls,.doc,.docx,.pdf,.hwp,.ppt,.pptx,.txt,.csv,.jpg,.jpeg,.png,.gif,.zip" onchange="handleFile(event)">
    <textarea id="msgInput" rows="1" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
    <button class="send-btn" onclick="sendMessage()">â¤</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Firebase Config â€” ì—¬ê¸°ë§Œ ìˆ˜ì •í•˜ë©´ ë©ë‹ˆë‹¤
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FIREBASE_CONFIG = {
  apiKey: "",
  authDomain: "",
  databaseURL: "",
  projectId: "",
  storageBucket: "",
  messagingSenderId: "",
  appId: ""
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Team Data
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TEAMS = [
  { id: 'livestock', team: 'ì¶•ìˆ˜ì‚°íŒ€', name: 'ìƒì˜', emoji: 'ğŸ¥©' },
  { id: 'agri', team: 'ë†ì‚°íŒ€', name: 'ì •í˜„', emoji: 'ğŸŒ¾' },
  { id: 'processed', team: 'ê°€ê³µíŒ€', name: 'ê¸°í˜„', emoji: 'ğŸ­' },
  { id: 'store', team: 'ë§¤ì¥ì‚¬ì—…íŒ€', name: 'ì¸ì„œìš¸', emoji: 'ğŸª' },
  { id: 'online', team: 'ì˜¨ë¼ì¸íŒ€', name: 'ì´ì§€ì›', emoji: 'ğŸ’»' },
  { id: 'exec', team: 'ì‚¬ì—…ìƒë¬´', name: '100ìƒë¬´ë‹˜', emoji: 'ğŸ‘”' }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser = null;
let firebaseReady = false;
let db = null;
let storage = null;
let messagesRef = null;
let submissions = {}; // teamId -> {fileName, fileData, fileType, texts:[]}
const BOT_NAME = 'ì‹­í˜•í˜¸ ğŸ§ ';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Firebase Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFirebase() {
  if (!FIREBASE_CONFIG.apiKey || !FIREBASE_CONFIG.databaseURL) {
    console.log('Firebase ë¯¸ì„¤ì • â†’ ë°ëª¨ ëª¨ë“œ');
    showDemoBadge();
    return false;
  }
  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.database();
    storage = firebase.storage();
    messagesRef = db.ref('report-chat/messages');
    firebaseReady = true;
    // Load submissions state
    db.ref('report-chat/submissions').on('value', snap => {
      if (snap.val()) submissions = snap.val();
      updateProgress();
    });
    return true;
  } catch(e) {
    console.error('Firebase init failed:', e);
    showDemoBadge();
    return false;
  }
}

function showDemoBadge() {
  const d = document.createElement('div');
  d.className = 'demo-badge';
  d.textContent = 'DEMO ëª¨ë“œ';
  document.body.appendChild(d);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Login
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildLoginScreen() {
  const grid = document.getElementById('teamGrid');
  TEAMS.forEach(t => {
    const card = document.createElement('div');
    card.className = 'team-card';
    card.innerHTML = `<div class="emoji">${t.emoji}</div><div class="team-name">${t.team}</div><div class="person">${t.name}</div>`;
    card.onclick = () => login(t);
    grid.appendChild(card);
  });
}

function login(team) {
  currentUser = team;
  localStorage.setItem('dure-chat-user', JSON.stringify(team));
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('chatScreen').style.display = 'flex';
  loadMessages();
  // Bot welcome
  setTimeout(() => {
    addBotMessage(`ì•ˆë…•í•˜ì„¸ìš” ${team.name}ë‹˜! ì‚¬ì—…ë³´ê³  ìë£Œë¥¼ ì²¨ë¶€í•´ì£¼ì„¸ìš”. ğŸ“\n\nğŸ’¡ ëª…ë ¹ì–´:\nâ€¢ /í˜„í™© â€” ì œì¶œ í˜„í™© ë³´ê¸°\nâ€¢ /ì·¨í•© â€” í˜„ì¬ê¹Œì§€ ì ‘ìˆ˜ë¶„ ì·¨í•©`);
  }, 500);
  updateProgress();
  document.getElementById('onlineStatus').textContent = `${team.team} ${team.name} ì ‘ì† ì¤‘`;
}

function logout() {
  currentUser = null;
  localStorage.removeItem('dure-chat-user');
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('chatScreen').style.display = 'none';
  document.getElementById('messages').innerHTML = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Messages
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadMessages() {
  if (firebaseReady) {
    messagesRef.orderByChild('timestamp').on('child_added', snap => {
      renderMessage(snap.val());
    });
  } else {
    const msgs = JSON.parse(localStorage.getItem('dure-chat-msgs') || '[]');
    msgs.forEach(m => renderMessage(m));
  }
}

function saveMessage(msg) {
  if (firebaseReady) {
    messagesRef.push(msg);
  } else {
    const msgs = JSON.parse(localStorage.getItem('dure-chat-msgs') || '[]');
    msgs.push(msg);
    localStorage.setItem('dure-chat-msgs', JSON.stringify(msgs));
    renderMessage(msg);
  }
}

function saveSubmissions() {
  if (firebaseReady) {
    db.ref('report-chat/submissions').set(submissions);
  } else {
    localStorage.setItem('dure-chat-subs', JSON.stringify(submissions));
  }
}

function loadSubmissions() {
  if (!firebaseReady) {
    submissions = JSON.parse(localStorage.getItem('dure-chat-subs') || '{}');
  }
}

function renderMessage(msg) {
  const container = document.getElementById('messages');
  
  if (msg.type === 'system') {
    const div = document.createElement('div');
    div.className = 'system-msg';
    div.textContent = msg.text;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    return;
  }

  const isMine = currentUser && msg.sender === currentUser.name && msg.team === currentUser.team;
  const isBot = msg.type === 'bot';
  
  const row = document.createElement('div');
  row.className = `msg-row ${isMine ? 'mine' : isBot ? 'bot' : 'other'}`;
  
  const avatarEmoji = isBot ? 'ğŸ§ ' : (TEAMS.find(t => t.name === msg.sender)?.emoji || 'ğŸ‘¤');
  
  let fileHtml = '';
  if (msg.fileName) {
    const icon = getFileIcon(msg.fileName);
    const dlAttr = msg.fileData ? `onclick="downloadFile('${encodeURIComponent(msg.fileName)}','${msg.fileData?.substring(0,50)==='data:'? 'stored':''}',this)" data-filedata="${msg.fileData||''}"` : '';
    fileHtml = `<div class="file-card">
      <div class="file-icon">${icon}</div>
      <div class="file-info"><div class="file-name">${escHtml(msg.fileName)}</div><div class="file-size">${msg.fileType||''}</div></div>
      ${msg.fileData ? `<button class="dl-btn" ${dlAttr}>ë‹¤ìš´ë¡œë“œ</button>` : ''}
    </div>`;
  }

  // Report download button
  let reportHtml = '';
  if (msg.reportData) {
    reportHtml = `<div style="margin-top:8px"><button class="report-btn" onclick="downloadReport(this)" data-report="${encodeURIComponent(msg.reportData)}">ğŸ“‹ HTML ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ</button>
    <button class="report-btn" style="background:var(--brown);margin-left:6px" onclick="downloadExcelReport(this)" data-report="${encodeURIComponent(msg.reportData)}">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button></div>`;
  }

  // Status table
  let statusHtml = '';
  if (msg.statusTable) {
    statusHtml = msg.statusTable;
  }

  const time = new Date(msg.timestamp).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
  
  row.innerHTML = `
    <div class="avatar">${avatarEmoji}</div>
    <div class="bubble">
      ${!isMine ? `<div class="sender-name">${escHtml(msg.sender)}${msg.team && !isBot ? ' Â· '+escHtml(msg.team):''}</div>` : ''}
      <div>${formatText(msg.text||'')}</div>
      ${fileHtml}${statusHtml}${reportHtml}
      <div class="msg-time">${time}</div>
    </div>`;
  
  container.appendChild(row);
  container.scrollTop = container.scrollHeight;
}

function formatText(t) {
  return escHtml(t).replace(/\n/g,'<br>');
}

function escHtml(s) {
  if(!s)return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function getFileIcon(name) {
  const ext = (name.split('.').pop()||'').toLowerCase();
  const icons = {xlsx:'ğŸ“Š',xls:'ğŸ“Š',csv:'ğŸ“Š',doc:'ğŸ“',docx:'ğŸ“',hwp:'ğŸ“',pdf:'ğŸ“•',ppt:'ğŸ“™',pptx:'ğŸ“™',txt:'ğŸ“„',jpg:'ğŸ–¼ï¸',jpeg:'ğŸ–¼ï¸',png:'ğŸ–¼ï¸',gif:'ğŸ–¼ï¸',zip:'ğŸ“¦'};
  return icons[ext]||'ğŸ“„';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Send Message
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sendMessage() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text || !currentUser) return;
  input.value = '';
  autoResize(input);

  // Commands
  if (text === '/í˜„í™©') { showStatus(); return; }
  if (text === '/ì·¨í•©') { generateReport(); return; }

  const msg = {
    sender: currentUser.name,
    team: currentUser.team,
    text: text,
    timestamp: Date.now(),
    type: 'user'
  };
  saveMessage(msg);

  // Track text messages per team
  if (!submissions[currentUser.id]) submissions[currentUser.id] = {};
  if (!submissions[currentUser.id].texts) submissions[currentUser.id].texts = [];
  submissions[currentUser.id].texts.push(text);
  submissions[currentUser.id].teamName = currentUser.team;
  submissions[currentUser.id].personName = currentUser.name;
  saveSubmissions();
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// File Upload
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleFile(e) {
  const file = e.target.files[0];
  if (!file || !currentUser) return;
  e.target.value = '';

  if (file.size > 5 * 1024 * 1024) {
    addBotMessage('âš ï¸ íŒŒì¼ í¬ê¸°ê°€ 5MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. ë” ì‘ì€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
    return;
  }

  const reader = new FileReader();
  reader.onload = function(ev) {
    const base64 = ev.target.result;
    
    if (firebaseReady && storage) {
      // Upload to Firebase Storage
      const ref = storage.ref(`report-files/${currentUser.id}/${file.name}`);
      ref.put(file).then(snapshot => snapshot.ref.getDownloadURL()).then(url => {
        postFileMessage(file.name, file.type, url);
      }).catch(err => {
        console.error('Storage upload failed, using base64:', err);
        postFileMessage(file.name, file.type, base64);
      });
    } else {
      postFileMessage(file.name, file.type, base64);
    }
  };
  reader.readAsDataURL(file);
}

function postFileMessage(fileName, fileType, fileData) {
  const msg = {
    sender: currentUser.name,
    team: currentUser.team,
    text: `ğŸ“ íŒŒì¼ì„ ì²¨ë¶€í–ˆìŠµë‹ˆë‹¤`,
    fileName, fileType, fileData,
    timestamp: Date.now(),
    type: 'user'
  };
  saveMessage(msg);

  // Track submission
  if (!submissions[currentUser.id]) submissions[currentUser.id] = {};
  submissions[currentUser.id].fileName = fileName;
  submissions[currentUser.id].fileType = fileType;
  submissions[currentUser.id].fileData = fileData;
  submissions[currentUser.id].teamName = currentUser.team;
  submissions[currentUser.id].personName = currentUser.name;
  submissions[currentUser.id].submittedAt = Date.now();
  saveSubmissions();
  updateProgress();

  const count = Object.keys(submissions).filter(k => submissions[k].fileName).length;
  
  setTimeout(() => {
    addBotMessage(`âœ… ${currentUser.team} ìë£Œ ì ‘ìˆ˜ ì™„ë£Œ! (${count}/6)`);
    
    if (count >= 6) {
      setTimeout(() => {
        addBotMessage('ğŸ‰ ì „ì²´ ì ‘ìˆ˜ ì™„ë£Œ! ì·¨í•© ë³´ê³ ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤...');
        setTimeout(() => generateReport(), 1500);
      }, 1000);
    }
  }, 800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// File Download
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function downloadFile(encodedName, type, btn) {
  const name = decodeURIComponent(encodedName);
  const data = btn.getAttribute('data-filedata');
  if (!data) return;
  
  if (data.startsWith('http')) {
    window.open(data, '_blank');
  } else {
    const a = document.createElement('a');
    a.href = data;
    a.download = name;
    a.click();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Bot Messages
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addBotMessage(text, extra) {
  const msg = {
    sender: BOT_NAME,
    team: '',
    text,
    timestamp: Date.now(),
    type: 'bot',
    ...extra
  };
  saveMessage(msg);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Status
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showStatus() {
  loadSubmissions();
  let tableHtml = '<table class="status-table"><tr><th>íŒ€</th><th>ë‹´ë‹¹</th><th>ìƒíƒœ</th><th>íŒŒì¼</th></tr>';
  TEAMS.forEach(t => {
    const sub = submissions[t.id];
    const done = sub && sub.fileName;
    tableHtml += `<tr><td>${t.team}</td><td>${t.name}</td><td>${done?'âœ… ì œì¶œ':'âŒ ë¯¸ì œì¶œ'}</td><td>${done?escHtml(sub.fileName):'-'}</td></tr>`;
  });
  tableHtml += '</table>';
  
  const count = Object.keys(submissions).filter(k => submissions[k]?.fileName).length;
  const msg = {
    sender: BOT_NAME, team: '', text: `ğŸ“Š ì œì¶œ í˜„í™© (${count}/6)`,
    timestamp: Date.now(), type: 'bot', statusTable: tableHtml
  };
  saveMessage(msg);
}

function updateProgress() {
  loadSubmissions();
  const bar = document.getElementById('progressBar');
  if (!bar) return;
  bar.innerHTML = '';
  TEAMS.forEach(t => {
    const done = submissions[t.id]?.fileName;
    const item = document.createElement('span');
    item.className = `progress-item ${done ? 'done' : 'pending'}`;
    item.textContent = `${done ? 'âœ…' : 'â¬œ'} ${t.team}`;
    bar.appendChild(item);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Report Generation
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateReport() {
  loadSubmissions();
  const now = new Date();
  const dateStr = `${now.getFullYear()}ë…„ ${now.getMonth()+1}ì›”`;
  
  let reportHtml = `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ë‘ë ˆìƒí˜‘ ì‚¬ì—…ë³´ê³  - ${dateStr}</title>
<style>body{font-family:-apple-system,'Noto Sans KR',sans-serif;max-width:800px;margin:0 auto;padding:40px 20px;color:#333;line-height:1.8}
h1{color:#2D5016;border-bottom:3px solid #2D5016;padding-bottom:12px;font-size:1.6em}
h2{color:#4a7a2e;margin-top:30px;font-size:1.2em;border-left:4px solid #2D5016;padding-left:12px}
.meta{color:#8B7355;font-size:.9em;margin-bottom:30px}
.team-section{background:#f9f7f2;border-radius:12px;padding:20px;margin:16px 0}
.file-badge{display:inline-block;background:#E8F5E1;color:#2D5016;padding:4px 12px;border-radius:8px;font-size:.85em;margin-top:8px}
.divider{border:none;border-top:1px solid #ddd;margin:24px 0}
.no-data{color:#999;font-style:italic}</style></head><body>
<h1>ğŸŒ¿ ë‘ë ˆìƒí˜‘ ì‚¬ì—…ë³¸ë¶€ ì›”ê°„ ì‚¬ì—…ë³´ê³ </h1>
<div class="meta">ì‘ì„±ì¼: ${dateStr} | ìë™ ì·¨í•© ë³´ê³ ì„œ</div><hr class="divider">`;

  TEAMS.forEach((t, i) => {
    const sub = submissions[t.id];
    reportHtml += `<h2>${i+1}. ${t.team} (${t.name})</h2><div class="team-section">`;
    if (sub) {
      const texts = sub.texts || [];
      if (texts.length) {
        reportHtml += `<p>${texts.map(escHtml).join('<br>')}</p>`;
      } else {
        reportHtml += `<p class="no-data">í…ìŠ¤íŠ¸ ë³´ê³  ì—†ìŒ</p>`;
      }
      if (sub.fileName) {
        reportHtml += `<div class="file-badge">ğŸ“ ì²¨ë¶€: ${escHtml(sub.fileName)}</div>`;
      }
    } else {
      reportHtml += `<p class="no-data">ë¯¸ì œì¶œ</p>`;
    }
    reportHtml += `</div>`;
  });

  reportHtml += `<hr class="divider"><p style="text-align:center;color:#999;font-size:.8em">ë‘ë ˆìƒí˜‘ ì‚¬ì—…ë³´ê³  ìë™ ì·¨í•© ì‹œìŠ¤í…œ</p></body></html>`;

  const count = Object.keys(submissions).filter(k => submissions[k]?.fileName).length;
  addBotMessage(`ğŸ“‹ ì·¨í•© ë³´ê³ ì„œê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤! (${count}/6íŒ€ ì ‘ìˆ˜ë¶„)`, {
    reportData: reportHtml
  });
}

function downloadReport(btn) {
  const html = decodeURIComponent(btn.getAttribute('data-report'));
  const blob = new Blob([html], {type:'text/html;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `ë‘ë ˆìƒí˜‘_ì‚¬ì—…ë³´ê³ _ì·¨í•©_${new Date().toISOString().slice(0,10)}.html`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function downloadExcelReport(btn) {
  if (typeof XLSX === 'undefined') { alert('SheetJS ë¡œë”© ì¤‘... ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); return; }
  loadSubmissions();
  const now = new Date();
  const data = [['ë‘ë ˆìƒí˜‘ ì‚¬ì—…ë³¸ë¶€ ì›”ê°„ ì‚¬ì—…ë³´ê³ '],[`ì‘ì„±ì¼: ${now.getFullYear()}ë…„ ${now.getMonth()+1}ì›”`],[],['íŒ€','ë‹´ë‹¹ì','ì œì¶œìƒíƒœ','í…ìŠ¤íŠ¸ ë³´ê³ ','ì²¨ë¶€íŒŒì¼']];
  TEAMS.forEach(t => {
    const sub = submissions[t.id];
    data.push([
      t.team, t.name,
      sub?.fileName ? 'ì œì¶œ' : 'ë¯¸ì œì¶œ',
      (sub?.texts||[]).join('\n') || '',
      sub?.fileName || ''
    ]);
  });
  const ws = XLSX.utils.aoa_to_sheet(data);
  ws['!cols'] = [{wch:14},{wch:10},{wch:8},{wch:40},{wch:20}];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ì‚¬ì—…ë³´ê³ ');
  XLSX.writeFile(wb, `ë‘ë ˆìƒí˜‘_ì‚¬ì—…ë³´ê³ _${now.toISOString().slice(0,10)}.xlsx`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
buildLoginScreen();
initFirebase();
loadSubmissions();

// Auto-login if saved
const saved = localStorage.getItem('dure-chat-user');
if (saved) {
  try { login(JSON.parse(saved)); } catch(e) {}
}
</script>
</body>
</html>
